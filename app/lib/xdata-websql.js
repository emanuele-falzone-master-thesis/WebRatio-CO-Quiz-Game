(function(GLOBAL,undefined,define){if(!GLOBAL["xdata"]){throw new Error("X-Data is not loaded");};;(function(){"use strict";'use strict';var DEBUG=false;var FILE_NAME="xdata-websql.js";var FILE_VERSION="0.9.3.201807181403";var exportSymbol=function(publicPath,object,objectToExportTo){};var exportProperty=function(object,publicName,symbol){};var EMPTY_FUNCTION=function(){};var ABSTRACT_METHOD=function(){throw new Error("Unimplemented abstract method");};var UNSUPPORTED_METHOD=function(){throw new Error("Operation not supported");};var newObject=function(proto,properties){var o;if(proto){var ctor=function(){};ctor.prototype=proto;o=new ctor}else o={};if(properties)for(var p in properties)if(properties.hasOwnProperty(p))o[p]=properties[p];return o};
var _extendConstructor=function(derived,base){derived._super=base.prototype;derived.prototype=newObject(base.prototype);derived.prototype["constructor"]=derived};var extendConstructor=_extendConstructor;var extendFunctionPrototype=(_extendConstructor);
var makeCustomErrorConstructor=function(name,base,constructor){base=base||GLOBAL["Error"];var ctor=function(){var tmp=null;this._super=function(){tmp=base.apply(this,arguments)};if(constructor)constructor.apply(this,arguments);if(!tmp)this._super.apply(this,arguments);delete this._super;this.name=name;this.message=tmp.message||name;if(typeof Error["captureStackTrace"]==="function")Error["captureStackTrace"](tmp,ctor);if(tmp.stack!==undefined)this.stack=tmp.stack};_extendConstructor(ctor,base);return ctor};var websql={};websql.ColumnData=function(purposeLabel){this._purposeLabel=purposeLabel;this._list=[];this._map={}};websql.ColumnData.prototype.getSize=function(){return this._list.length};websql.ColumnData.prototype.getAll=function(){return this._list};websql.ColumnData.prototype.get=function(column){return this._doGet(column,undefined)};websql.ColumnData.prototype.getSpecific=function(column,extraKey){return this._doGet(column,extraKey)};
websql.ColumnData.prototype._doGet=function(column,extraKey){var key=this._computeKey(column,extraKey);return this._map[key]||null};websql.ColumnData.prototype.has=function(column){return this._doHas(column,undefined)};websql.ColumnData.prototype.hasSpecific=function(column,extraKey){return this._doHas(column,extraKey)};websql.ColumnData.prototype._doHas=function(column,extraKey){var key=this._computeKey(column,extraKey);return!!this._map[key]};
websql.ColumnData.prototype.add=function(column,data){this._doAdd(column,undefined,data)};websql.ColumnData.prototype.addSpecific=function(column,extraKey,data){this._doAdd(column,extraKey,data);if(!this._doHas(column,undefined))this._doAdd(column,undefined,data,true)};
websql.ColumnData.prototype._doAdd=function(column,extraKey,data,mapOnly){var key=this._computeKey(column,extraKey);if(this._map[key])throw new Error(this._computeKeyMessage(column,extraKey)+" already added as "+this._purposeLabel);this._map[key]=data;if(!mapOnly)this._list.push(data)};websql.ColumnData.prototype._computeKey=function(column,extraKey){var baseKey='"'+column.table.name+'"."'+column.name+'"';if(extraKey!==undefined)return baseKey+","+String(extraKey);return baseKey};
websql.ColumnData.prototype._computeKeyMessage=function(column,extraKey){var message="Column "+column+" of table "+column.table;if(extraKey!==undefined)message+=" as '"+extraKey+"'";return message};websql.runTransaction=function(db,dbConn,writeEnabled,txCallback,errorCallback,successCallback){var listeners=db.getListeners();var method=writeEnabled?dbConn.transaction:dbConn.readTransaction;method.call(dbConn,function(tx){listeners.notifyBegunTransaction(writeEnabled);txCallback(tx)},function(e){listeners.notifyResolvedTransaction(writeEnabled,false);if(errorCallback)errorCallback(e)},function(){listeners.notifyResolvedTransaction(writeEnabled,true);if(successCallback)successCallback()})};
exportSymbol("websql.runTransaction",websql.runTransaction);
websql.executeSql=function(db,dbTx,sql,sqlParams,callback,errorCallback){var listeners=db.getListeners();listeners.notifyExecutingSql(sql,sqlParams);dbTx.executeSql(sql,sqlParams,function(tx,result){websql.activeTx=tx;try{listeners.notifyExecutedSql(sql,sqlParams);if(callback)callback(tx,result)}finally{websql.activeTx=null}},function(tx,e){websql.activeTx=tx;try{listeners.notifyExecutedSql(sql,sqlParams,e);var propagateError=true;if(errorCallback)propagateError=errorCallback(tx,e);return propagateError!==
false?true:false}finally{websql.activeTx=null}})};websql.activeTx=null;websql.createErrorCallback=function(callback){function errorCallbackWrapper(tx,e,sql,sqlParams){callback(websql.createError(e,sql,sqlParams))}return errorCallbackWrapper};websql.createError=function(e,sql,sqlParams){var msg="SQL"+e.code+" ("+e.message+")";msg+="\nQuery text: "+(sql||"\x3cn/a\x3e");msg+="\nQuery parameters: "+(sqlParams?JSON.stringify(sqlParams):"\x3cn/a\x3e");return new Error(msg)};
websql.installOpenDatabaseCache=function(){var _openDatabase=GLOBAL.openDatabase;if(typeof _openDatabase!=="function"||_openDatabase["_xdata"]===true)return;var cache={};function openDatabaseWithCache(name,version,description,size,dbCallback){var key=""+name+"__"+String(version)+"__"+description+"__"+size;var db=cache[key];if(!db){db=_openDatabase.call(GLOBAL,name,version,description,size,dbCallback);cache[key]=db}return db}Object.defineProperty(openDatabaseWithCache,"_xdata",{value:true});GLOBAL.openDatabase=
openDatabaseWithCache};websql.Command=function(){};exportSymbol("websql.Command",websql.Command);websql.Command.prototype.execute=ABSTRACT_METHOD;exportProperty(websql.Command.prototype,"execute",websql.Command.prototype.execute);websql.Command.prototype.computeExpectedInputCount=ABSTRACT_METHOD;exportProperty(websql.Command.prototype,"computeExpectedInputCount",websql.Command.prototype.computeExpectedInputCount);websql.Command.InputInfo;websql.Command.OutputInfo;
websql.Command.prototype.executeQuery=function(tx,query,parameters,callback,errorCallback){var db=tx.getDatabase();var sqlParams=query.inputData.map(function(inputInfo){var parameterValue=parameters[inputInfo.parameterName];if(parameterValue!==undefined&&inputInfo.elementIndex!==undefined)parameterValue=parameterValue[inputInfo.elementIndex];return inputInfo.converter.toSQL(parameterValue)},this);tx.runInTransaction(function(tx){websql.executeSql(db,tx,query.sql,sqlParams,callback,function(tx,e){errorCallback(tx,
e,query.sql,sqlParams)})})};exportProperty(websql.Command.prototype,"executeQuery",websql.Command.prototype.executeQuery);websql.query={};websql.query.Builder=function(){};exportSymbol("websql.query.Builder",websql.query.Builder);websql.query.Builder.prototype.groupStart=function(openingSql){};exportProperty(websql.query.Builder.prototype,"groupStart",websql.query.Builder.prototype.groupStart);websql.query.Builder.prototype.separator=function(separatorSql){};exportProperty(websql.query.Builder.prototype,"separator",websql.query.Builder.prototype.separator);websql.query.Builder.prototype.groupEnd=function(closingSql){};
exportProperty(websql.query.Builder.prototype,"groupEnd",websql.query.Builder.prototype.groupEnd);websql.query.Builder.prototype.sql=function(sql){};exportProperty(websql.query.Builder.prototype,"sql",websql.query.Builder.prototype.sql);websql.query.Builder.prototype.name=function(var_args){};exportProperty(websql.query.Builder.prototype,"name",websql.query.Builder.prototype.name);websql.query.Builder.prototype.quotedName=function(var_args){};
exportProperty(websql.query.Builder.prototype,"quotedName",websql.query.Builder.prototype.quotedName);websql.query.Builder.prototype.inputPlaceholder=function(data){};exportProperty(websql.query.Builder.prototype,"inputPlaceholder",websql.query.Builder.prototype.inputPlaceholder);websql.query.Builder.prototype.fragment=function(query){};exportProperty(websql.query.Builder.prototype,"fragment",websql.query.Builder.prototype.fragment);websql.query.Builder.prototype.createAlias=function(prefix){};
exportProperty(websql.query.Builder.prototype,"createAlias",websql.query.Builder.prototype.createAlias);websql.query.Query=function(){};exportSymbol("websql.query.Query",websql.query.Query);websql.query.Query.prototype.sql;exportProperty(websql.query.Query.prototype,"sql",websql.query.Query.prototype.sql);websql.query.Query.prototype.inputData;exportProperty(websql.query.Query.prototype,"inputData",websql.query.Query.prototype.inputData);websql.query.QueryImpl=function(sql,inputData){this.sql=sql;this.inputData=inputData?inputData.slice():[]};websql.query.QueryBuilder=function(options){this._text="";this._pendingSeparator=null;this._outerGroups=null;this._inputData=null;this._aliasPrefix=options&&options.aliasPrefix||"";this._aliasCounts=null};exportSymbol("websql.query.QueryBuilder",websql.query.QueryBuilder);
websql.query.QueryBuilder.prototype.groupStart=function(openingSql){openingSql=openingSql||"";this._doAppend(openingSql);if(!this._outerGroups)this._outerGroups=[];this._outerGroups.push({pendingSeparator:this._pendingSeparator});this._pendingSeparator=null;return this};exportProperty(websql.query.QueryBuilder.prototype,"groupStart",websql.query.QueryBuilder.prototype.groupStart);websql.query.QueryBuilder.prototype.separator=function(separatorSql){this._pendingSeparator=separatorSql;return this};
exportProperty(websql.query.QueryBuilder.prototype,"separator",websql.query.QueryBuilder.prototype.separator);websql.query.QueryBuilder.prototype.groupEnd=function(closingSql){closingSql=closingSql||"";if(DEBUG&&(!this._outerGroups||this._outerGroups.length<=0))throw new Error("No current group");var group=this._outerGroups.pop();this._doAppend(closingSql,true);this._pendingSeparator=group.pendingSeparator;return this};exportProperty(websql.query.QueryBuilder.prototype,"groupEnd",websql.query.QueryBuilder.prototype.groupEnd);
websql.query.QueryBuilder.prototype.sql=function(sql){if(sql)this._doAppend(sql);return this};exportProperty(websql.query.QueryBuilder.prototype,"sql",websql.query.QueryBuilder.prototype.sql);websql.query.QueryBuilder.prototype.name=function(var_args){if(arguments.length<=0)return this;var args=[];for(var i=0;i<arguments.length;i++)args[i]=arguments[i];this._doAppendName(args);return this};exportProperty(websql.query.QueryBuilder.prototype,"name",websql.query.QueryBuilder.prototype.name);
websql.query.QueryBuilder.prototype._doAppendName=function(parts){if(parts.length===1)return this._doAppend(parts[0]);if(parts.length===2&&parts[0]==="main")return this._doAppendName(parts.slice(1));var s="";for(var i=0;i<parts.length;i++){if(i>0)s=s.concat(".");s=s.concat(parts[i])}return this._doAppend(s)};
websql.query.QueryBuilder.prototype.quotedName=function(var_args){if(arguments.length<=0)return this;var args=[];for(var i=0;i<arguments.length;i++)args[i]=arguments[i];this._doAppendQuotedName(args);return this};exportProperty(websql.query.QueryBuilder.prototype,"quotedName",websql.query.QueryBuilder.prototype.quotedName);
websql.query.QueryBuilder.prototype._doAppendQuotedName=function(parts){if(parts.length===1)return this._doAppend('"'+parts[0].replace(/"/g,'""')+'"');if(parts.length===2&&(parts[0]==="main"||parts[0]===""))return this._doAppendQuotedName(parts.slice(1));var s='"';for(var i=0;i<parts.length;i++){if(i>0)s=s.concat('"."');s=s.concat(parts[i].replace(/"/g,'""'))}s=s.concat('"');return this._doAppend(s)};
websql.query.QueryBuilder.prototype.inputPlaceholder=function(data){this._doAppend("?");if(!this._inputData)this._inputData=[];this._inputData.push(data);return this};exportProperty(websql.query.QueryBuilder.prototype,"inputPlaceholder",websql.query.QueryBuilder.prototype.inputPlaceholder);
websql.query.QueryBuilder.prototype._doAppend=function(sql,ignoreSeparator){if(this._pendingSeparator)if(!ignoreSeparator)this._text=this._text.concat(this._pendingSeparator);this._text=this._text.concat(sql);this._pendingSeparator=" "};websql.query.QueryBuilder.prototype.fragment=function(query){this.sql(query.sql);if(!this._inputData)this._inputData=[];Array.prototype.push.apply(this._inputData,query.inputData);return this};exportProperty(websql.query.QueryBuilder.prototype,"fragment",websql.query.QueryBuilder.prototype.fragment);
websql.query.QueryBuilder.prototype.createAlias=function(prefix){var aliasCounts=this._aliasCounts;if(!aliasCounts)this._aliasCounts=aliasCounts={};var count=aliasCounts[prefix]||0;aliasCounts[prefix]=count+1;return this._aliasPrefix+prefix+count};exportProperty(websql.query.QueryBuilder.prototype,"createAlias",websql.query.QueryBuilder.prototype.createAlias);websql.query.QueryBuilder.prototype.getInputCount=function(){return this._inputData?this._inputData.length:0};
exportProperty(websql.query.QueryBuilder.prototype,"getInputCount",websql.query.QueryBuilder.prototype.getInputCount);websql.query.QueryBuilder.prototype.build=function(){return new websql.query.QueryImpl(this.buildSQL(),this._inputData)};exportProperty(websql.query.QueryBuilder.prototype,"build",websql.query.QueryBuilder.prototype.build);websql.query.QueryBuilder.prototype.buildSQL=function(){if(DEBUG&&(this._outerGroups&&this._outerGroups.length>0))throw new Error("Groups left open");return this._text};
exportProperty(websql.query.QueryBuilder.prototype,"buildSQL",websql.query.QueryBuilder.prototype.buildSQL);websql.query.QueryBuilder.prototype.toString=function(){return this.buildSQL()};exportProperty(websql.query.QueryBuilder.prototype,"toString",websql.query.QueryBuilder.prototype.toString);websql.query.QueryTemplate=function(){};exportSymbol("websql.query.QueryTemplate",websql.query.QueryTemplate);websql.query.QueryTemplate.prototype.isConstant=function(){};exportProperty(websql.query.QueryTemplate.prototype,"isConstant",websql.query.QueryTemplate.prototype.isConstant);websql.query.QueryTemplate.prototype.expand=function(parameters){};exportProperty(websql.query.QueryTemplate.prototype,"expand",websql.query.QueryTemplate.prototype.expand);websql.query.QueryTemplateBuilder=function(options){this._queryBuilder=new websql.query.QueryBuilder(options);this._expansions=[]};exportSymbol("websql.query.QueryTemplateBuilder",websql.query.QueryTemplateBuilder);websql.query.QueryTemplateBuilder.prototype.toString=function(){return this._queryBuilder.toString()};exportProperty(websql.query.QueryTemplateBuilder.prototype,"toString",websql.query.QueryTemplateBuilder.prototype.toString);
websql.query.QueryTemplateBuilder.prototype.groupStart=function(openingSql){this._queryBuilder.groupStart(openingSql);return this};exportProperty(websql.query.QueryTemplateBuilder.prototype,"groupStart",websql.query.QueryTemplateBuilder.prototype.groupStart);websql.query.QueryTemplateBuilder.prototype.separator=function(separatorSql){this._queryBuilder.separator(separatorSql);return this};exportProperty(websql.query.QueryTemplateBuilder.prototype,"separator",websql.query.QueryTemplateBuilder.prototype.separator);
websql.query.QueryTemplateBuilder.prototype.groupEnd=function(closingSql){this._queryBuilder.groupEnd(closingSql);return this};exportProperty(websql.query.QueryTemplateBuilder.prototype,"groupEnd",websql.query.QueryTemplateBuilder.prototype.groupEnd);websql.query.QueryTemplateBuilder.prototype.sql=function(sql){this._queryBuilder.sql(sql);return this};exportProperty(websql.query.QueryTemplateBuilder.prototype,"sql",websql.query.QueryTemplateBuilder.prototype.sql);
websql.query.QueryTemplateBuilder.prototype.name=function(var_args){this._queryBuilder.name.apply(this._queryBuilder,arguments);return this};exportProperty(websql.query.QueryTemplateBuilder.prototype,"name",websql.query.QueryTemplateBuilder.prototype.name);websql.query.QueryTemplateBuilder.prototype.quotedName=function(var_args){this._queryBuilder.quotedName.apply(this._queryBuilder,arguments);return this};exportProperty(websql.query.QueryTemplateBuilder.prototype,"quotedName",websql.query.QueryTemplateBuilder.prototype.quotedName);
websql.query.QueryTemplateBuilder.prototype.inputPlaceholder=function(data){this._queryBuilder.inputPlaceholder(data);return this};exportProperty(websql.query.QueryTemplateBuilder.prototype,"inputPlaceholder",websql.query.QueryTemplateBuilder.prototype.inputPlaceholder);websql.query.QueryTemplateBuilder.prototype.fragment=function(query){this._queryBuilder.fragment(query);return this};exportProperty(websql.query.QueryTemplateBuilder.prototype,"fragment",websql.query.QueryTemplateBuilder.prototype.fragment);
websql.query.QueryTemplateBuilder.prototype.expansion=function(expanderOrTemplate){var template;if(typeof expanderOrTemplate==="function")template=new websql.query.QueryTemplateBuilder._FunctionTemplate(expanderOrTemplate);else template=expanderOrTemplate;if(template.isConstant()){var constantQuery=template.expand(undefined);this._queryBuilder.fragment(constantQuery);return this}var index=this._expansions.length;this._expansions.push({template:template,inputOffset:this._queryBuilder.getInputCount()});
this._queryBuilder.sql("@"+index+"@");return this};exportProperty(websql.query.QueryTemplateBuilder.prototype,"expansion",websql.query.QueryTemplateBuilder.prototype.expansion);websql.query.QueryTemplateBuilder._FunctionTemplate=function(expander){this.expand=expander};websql.query.QueryTemplateBuilder._FunctionTemplate.prototype.isConstant=function(){return false};websql.query.QueryTemplateBuilder.prototype.createAlias=function(prefix){return this._queryBuilder.createAlias(prefix)};
exportProperty(websql.query.QueryTemplateBuilder.prototype,"createAlias",websql.query.QueryTemplateBuilder.prototype.createAlias);websql.query.QueryTemplateBuilder.prototype.build=function(){if(this._expansions.length>0)return new websql.query.QueryTemplateBuilder._RegularTemplate(this._queryBuilder,this._expansions);return new websql.query.QueryTemplateBuilder._ConstantTemplate(this._queryBuilder)};exportProperty(websql.query.QueryTemplateBuilder.prototype,"build",websql.query.QueryTemplateBuilder.prototype.build);
websql.query.QueryTemplateBuilder._ConstantTemplate=function(queryBuilder){this._query=queryBuilder.build()};websql.query.QueryTemplateBuilder._ConstantTemplate.prototype.isConstant=function(){return true};websql.query.QueryTemplateBuilder._ConstantTemplate.prototype.expand=function(parameters){return this._query};websql.query.QueryTemplateBuilder._RegularTemplate=function(queryBuilder,expansions){this._query=queryBuilder.build();this._expansions=expansions.slice()};
websql.query.QueryTemplateBuilder._RegularTemplate.prototype.isConstant=function(){return false};
websql.query.QueryTemplateBuilder._RegularTemplate.prototype.expand=function(parameters){var $jscomp$this=this;var mainInputData=this._query.inputData;var lastMainInputOffset=0;function copyMainInputData(finalOffset){if(finalOffset>lastMainInputOffset){Array.prototype.push.apply(inputData,mainInputData.slice(lastMainInputOffset,finalOffset));lastMainInputOffset=finalOffset}}var inputData=[];var sql=this._query.sql.replace(/@(\d+)@/g,function(placeholder,indexString){var expansion=$jscomp$this._expansions[Number(indexString)];
var subQuery=expansion.template.expand(parameters);copyMainInputData(expansion.inputOffset);Array.prototype.push.apply(inputData,subQuery.inputData);return subQuery.sql});copyMainInputData(mainInputData.length);return new websql.query.QueryImpl(sql,inputData)};websql.CommandBuilder=function(db,storeOrRelationName,options){var schema=db.getSchema();this.db=db;this._storeOrRelationName=storeOrRelationName;this._worker=new websql.CommandBuilder._Worker(schema,storeOrRelationName,!!(options&&options.forbidJoins));this._flatWorker=options&&options.flatVariants?new websql.CommandBuilder._Worker(schema,storeOrRelationName,true):null;this._outputRowidPropertyName=null};exportSymbol("websql.CommandBuilder",websql.CommandBuilder);
websql.CommandBuilder.prototype.includeInputField=function(fieldPath,valueParameter){this._invokeWorkers(function(worker){worker._includeInputField(fieldPath,valueParameter)})};exportProperty(websql.CommandBuilder.prototype,"includeInputField",websql.CommandBuilder.prototype.includeInputField);websql.CommandBuilder.prototype.includeOutputRowid=function(propertyName){if(this._outputRowidPropertyName)throw new Error("Rowid already included as output");this._outputRowidPropertyName=propertyName};
exportProperty(websql.CommandBuilder.prototype,"includeOutputRowid",websql.CommandBuilder.prototype.includeOutputRowid);websql.CommandBuilder.prototype.includeOutputField=function(fieldPath,propertyName){this._invokeWorkers(function(worker){worker._includeOutputField(fieldPath,propertyName)})};exportProperty(websql.CommandBuilder.prototype,"includeOutputField",websql.CommandBuilder.prototype.includeOutputField);websql.CommandBuilder.prototype.includeFilter=function(expr){this._invokeWorkers(function(worker){worker._includeFilter(expr)})};
exportProperty(websql.CommandBuilder.prototype,"includeFilter",websql.CommandBuilder.prototype.includeFilter);websql.CommandBuilder.prototype.includeFilterOnRowid=function(valueParameter){this._invokeWorkers(function(worker){worker._includeFilterOnRowid(valueParameter)})};exportProperty(websql.CommandBuilder.prototype,"includeFilterOnRowid",websql.CommandBuilder.prototype.includeFilterOnRowid);websql.CommandBuilder.prototype.includeOrderTerm=function(term){this._invokeWorkers(function(worker){worker._includeOrderTerm(term)})};
exportProperty(websql.CommandBuilder.prototype,"includeOrderTerm",websql.CommandBuilder.prototype.includeOrderTerm);websql.CommandBuilder.prototype.includeLimit=function(limit){this._invokeWorkers(function(worker){worker._includeLimit(limit)})};exportProperty(websql.CommandBuilder.prototype,"includeLimit",websql.CommandBuilder.prototype.includeLimit);
websql.CommandBuilder.prototype._invokeWorkers=function(callback){callback.call(this,this._worker);if(this._flatWorker)if(this._worker._joined)this._flatWorker=null;else callback.call(this,this._flatWorker)};websql.CommandBuilder.prototype.getInputColumn=function(column){var inputColumnData=this._getWorker()._inputColumns;var inputColumn=inputColumnData.get(column);if(inputColumn)return this._createInputColumnInputInfo(inputColumn);return null};
websql.CommandBuilder.prototype._createInputColumnInputInfo=function(inputColumn){return{parameterName:inputColumn.valueParameter,elementIndex:undefined,converter:inputColumn.column.converter}};
websql.CommandBuilder.prototype.getResultColumns=function(){var outputInfos=this._getWorker()._resultColumns.getAll().map(this._createResultColumnOutputInfo,this);if(this._outputRowidPropertyName)outputInfos.unshift({alias:websql.CommandBuilder._ROWID_ALIAS,converter:websql.Converters[websql.query.ROWID_COLUMN_TYPE],propertyName:this._outputRowidPropertyName});return outputInfos};
websql.CommandBuilder.prototype.getResultColumn=function(column){var resultColumnData=this._getWorker()._resultColumns;var resultColumn=resultColumnData.get(column);if(resultColumn)return this._createResultColumnOutputInfo(resultColumn);return null};websql.CommandBuilder.prototype._createResultColumnOutputInfo=function(resultColumn){return{alias:resultColumn.alias,converter:resultColumn.column.converter,propertyName:resultColumn.propertyName}};websql.CommandBuilder.prototype.hasOrderColumn=function(column){return this._getWorker()._orderColumns.has(column)};
websql.CommandBuilder.prototype.isJoined=function(){return this._getWorker()._joined};websql.CommandBuilder.prototype.isJoinedToMany=function(){return this._getWorker()._joinedToMany};websql.CommandBuilder.prototype.getBaseDataSet=function(){return this._getWorker()._baseDataSet};websql.CommandBuilder.prototype.getDataSets=function(){var worker=this._getWorker();return[worker._baseDataSet].concat(worker._dataSets)};
websql.CommandBuilder.prototype.isRowidAliasField=function(fieldPath){var worker=this._getWorker();var parsedPath=worker._parseFieldPath(fieldPath);var baseDataSet=worker._baseDataSet;var column=worker._locateFieldColumn(baseDataSet.element,parsedPath.relationEndNames,parsedPath.fieldName);return column===this.getRowidAliasColumn()};
websql.CommandBuilder.prototype.getRowidAliasColumn=function(){var baseDataSet=this.getBaseDataSet();if(baseDataSet.element instanceof websql.schema.Table)return baseDataSet.element.rowidAliasColumn;else return baseDataSet.element.accessor.getBaseTable().rowidAliasColumn};websql.CommandBuilder.prototype.build=ABSTRACT_METHOD;exportProperty(websql.CommandBuilder.prototype,"build",websql.CommandBuilder.prototype.build);
websql.CommandBuilder.prototype.isFlatQueriesOnly=function(){return this._getWorker()===this._flatWorker};exportProperty(websql.CommandBuilder.prototype,"isFlatQueriesOnly",websql.CommandBuilder.prototype.isFlatQueriesOnly);websql.CommandBuilder.prototype.buildTableExpression=function(){var table=this._getBaseTable();var b=new websql.query.QueryBuilder;return b.quotedName(table.dbName,table.name)};exportProperty(websql.CommandBuilder.prototype,"buildTableExpression",websql.CommandBuilder.prototype.buildTableExpression);
websql.CommandBuilder.prototype.buildResultList=function(extraColumns){var worker=this._getWorker();var resultColumns=worker._resultColumns.getAll();if(extraColumns&&extraColumns.length>0)resultColumns=resultColumns.concat(extraColumns);if(!this._outputRowidPropertyName&&resultColumns.length<=0)return"NULL";var b=new websql.query.QueryBuilder;b.groupStart();if(this._outputRowidPropertyName){b.quotedName(worker._baseDataSet.alias||"",websql.query.ROWID_COLUMN_NAME);b.sql("AS").name(websql.CommandBuilder._ROWID_ALIAS);
b.separator(", ")}resultColumns.forEach(function(resultColumn){b.quotedName(resultColumn.dataSet.alias||"",resultColumn.column.name);b.sql("AS").name(resultColumn.alias);b.separator(", ")});b.groupEnd();return b.buildSQL()};exportProperty(websql.CommandBuilder.prototype,"buildResultList",websql.CommandBuilder.prototype.buildResultList);websql.CommandBuilder.prototype.buildFromExpression=function(){return this._getWorker()._fromBuilder.buildSQL()};
exportProperty(websql.CommandBuilder.prototype,"buildFromExpression",websql.CommandBuilder.prototype.buildFromExpression);websql.CommandBuilder.prototype.buildInsertList=function(){var inputColumns=this._getWorker()._inputColumns.getAll();if(inputColumns.length<=0)throw new Error("No input columns specified");var b=new websql.query.QueryBuilder;b.groupStart("(");inputColumns.forEach(function(inputColumn){b.quotedName(inputColumn.column.name);b.separator(",")});b.groupEnd(")");return b.buildSQL()};
exportProperty(websql.CommandBuilder.prototype,"buildInsertList",websql.CommandBuilder.prototype.buildInsertList);
websql.CommandBuilder.prototype.buildValuesList=function(){var $jscomp$this=this;var inputColumns=this._getWorker()._inputColumns.getAll();if(inputColumns.length<=0)throw new Error("No input columns specified");var b=new websql.query.QueryBuilder;b.groupStart("(");inputColumns.forEach(function(inputColumn){b.inputPlaceholder($jscomp$this._createInputColumnInputInfo(inputColumn));b.separator(",")});b.groupEnd(")");return b.build()};exportProperty(websql.CommandBuilder.prototype,"buildValuesList",websql.CommandBuilder.prototype.buildValuesList);
websql.CommandBuilder.prototype.buildSetList=function(){var $jscomp$this=this;var inputColumns=this._getWorker()._inputColumns.getAll();if(inputColumns.length<=0)throw new Error("No input columns specified");var b=new websql.query.QueryBuilder;b.groupStart();inputColumns.forEach(function(inputColumn){b.quotedName(inputColumn.column.name);b.sql("\x3d").inputPlaceholder($jscomp$this._createInputColumnInputInfo(inputColumn));b.separator(", ")});b.groupEnd();return b.build()};
exportProperty(websql.CommandBuilder.prototype,"buildSetList",websql.CommandBuilder.prototype.buildSetList);websql.CommandBuilder.prototype.isWhereExpressionAvailable=function(){return!!this._getWorker()._whereBuilder};exportProperty(websql.CommandBuilder.prototype,"isWhereExpressionAvailable",websql.CommandBuilder.prototype.isWhereExpressionAvailable);
websql.CommandBuilder.prototype.buildWhereExpression=function(){var worker=this._getWorker();if(!worker._whereBuilder)throw new Error("No filters specified");return worker._whereBuilder.build()};exportProperty(websql.CommandBuilder.prototype,"buildWhereExpression",websql.CommandBuilder.prototype.buildWhereExpression);
websql.CommandBuilder.prototype.buildWhereSubQuery=function(){var worker=this._getWorker();var baseDataSetAlias=worker._baseDataSet.alias;var b=new websql.query.QueryTemplateBuilder;b.sql("SELECT");b.quotedName(baseDataSetAlias||"",websql.query.ROWID_COLUMN_NAME);b.sql("FROM").sql(this.buildFromExpression());if(this.isWhereExpressionAvailable())b.sql("WHERE").expansion(this.buildWhereExpression());return b.build()};exportProperty(websql.CommandBuilder.prototype,"buildWhereSubQuery",websql.CommandBuilder.prototype.buildWhereSubQuery);
websql.CommandBuilder.prototype.buildFlatWhereOnRowid=function(valueParameter){var operatorHandler=websql.OperatorHandlers.VALUE[xdata.ValueOperator.IN];var converter=websql.Converters[websql.query.ROWID_COLUMN_TYPE];var leftOperand=function(builder){return builder.quotedName("",websql.query.ROWID_COLUMN_NAME)};var rightOperand={appender:function(builder,index){builder.inputPlaceholder({parameterName:valueParameter,elementIndex:index,converter:converter})},parameterName:valueParameter,internalOperator:xdata.CollectionOperator.ANY};
var b=new websql.query.QueryTemplateBuilder;operatorHandler.appendExpansion(b,converter,leftOperand,rightOperand);return b.build()};exportProperty(websql.CommandBuilder.prototype,"buildFlatWhereOnRowid",websql.CommandBuilder.prototype.buildFlatWhereOnRowid);websql.CommandBuilder.prototype.isRelationInsertionByUpdate=function(){return this._getBaseRelation().accessor.insertsByUpdating()};exportProperty(websql.CommandBuilder.prototype,"isRelationInsertionByUpdate",websql.CommandBuilder.prototype.isRelationInsertionByUpdate);
websql.CommandBuilder.prototype.buildRelationTupleInsertionQuery=function(){var $jscomp$this=this;var worker=this._getWorker();var b=new websql.query.QueryTemplateBuilder;this._getBaseRelation().accessor.appendTupleInsertion(b,function(builder,column){var inputColumn=worker._inputColumns.get(column);if(!inputColumn)throw new Error("Must provide an input for column '"+column+"'");builder.inputPlaceholder($jscomp$this._createInputColumnInputInfo(inputColumn))});return b.build()};
exportProperty(websql.CommandBuilder.prototype,"buildRelationTupleInsertionQuery",websql.CommandBuilder.prototype.buildRelationTupleInsertionQuery);
websql.CommandBuilder.prototype.buildRelationTupleUpdatingQueryProlog=function(){var $jscomp$this=this;var worker=this._getWorker();var b=new websql.query.QueryBuilder;this._getBaseRelation().accessor.appendTupleUpdating(b,function(builder,column){var inputColumn=worker._inputColumns.get(column);if(!inputColumn)throw new Error("Must provide an input for column '"+column+"'");builder.inputPlaceholder($jscomp$this._createInputColumnInputInfo(inputColumn))},function(column){return worker._inputColumns.has(column)});
return b.build()};exportProperty(websql.CommandBuilder.prototype,"buildRelationTupleUpdatingQueryProlog",websql.CommandBuilder.prototype.buildRelationTupleUpdatingQueryProlog);websql.CommandBuilder.prototype.buildRelationTupleDeletionQueryProlog=function(){var b=new websql.query.QueryBuilder;this._getBaseRelation().accessor.appendTupleDeletion(b);return b.buildSQL()};exportProperty(websql.CommandBuilder.prototype,"buildRelationTupleDeletionQueryProlog",websql.CommandBuilder.prototype.buildRelationTupleDeletionQueryProlog);
websql.CommandBuilder.prototype.isOrderExpressionAvailable=function(){return!!this._getWorker()._orderColumns.getSize()>0};exportProperty(websql.CommandBuilder.prototype,"isOrderExpressionAvailable",websql.CommandBuilder.prototype.isOrderExpressionAvailable);
websql.CommandBuilder.prototype.buildOrderExpression=function(extraTerms){var worker=this._getWorker();var orderColumns=worker._orderColumns.getAll();if(extraTerms&&extraTerms.length>0)orderColumns=orderColumns.concat(extraTerms);if(orderColumns.length<=0)throw new Error("No order terms specified");var b=new websql.query.QueryBuilder;b.groupStart();orderColumns.forEach(function(orderColumn){orderColumn.column.converter.appendComparableTermExpansion(b,function(builder){builder.quotedName(orderColumn.dataSet.alias||
"",orderColumn.column.name)});if(orderColumn.descending)b.sql("DESC");b.separator(", ")});b.groupEnd();return b.buildSQL()};exportProperty(websql.CommandBuilder.prototype,"buildOrderExpression",websql.CommandBuilder.prototype.buildOrderExpression);websql.CommandBuilder.prototype.isLimitExpressionAvailable=function(){return!!this._getWorker()._limit};exportProperty(websql.CommandBuilder.prototype,"isLimitExpressionAvailable",websql.CommandBuilder.prototype.isLimitExpressionAvailable);
websql.CommandBuilder.prototype.buildLimitExpression=function(){var worker=this._getWorker();var limit=worker._limit;if(!limit)throw new Error("No limit specified");var b=new websql.query.QueryBuilder;b.sql(String(limit.count));if(limit.offset!==undefined)b.sql("OFFSET").sql(String(limit.offset));return b.buildSQL()};exportProperty(websql.CommandBuilder.prototype,"buildLimitExpression",websql.CommandBuilder.prototype.buildLimitExpression);
websql.CommandBuilder.prototype._getBaseTable=function(){var worker=this._getWorker();var baseTable=worker._baseDataSet.element;if(!(baseTable instanceof websql.schema.Table))throw new Error("Not based on a table");return baseTable};websql.CommandBuilder.prototype._getBaseRelation=function(){var worker=this._getWorker();var baseRelation=worker._baseDataSet.element;if(!(baseRelation instanceof websql.schema.Relation))throw new Error("Not based on a relation");return baseRelation};
websql.CommandBuilder.prototype._getWorker=function(){return this._flatWorker||this._worker};websql.CommandBuilder.DataSet;websql.CommandBuilder._resolveFieldColumn=function(element,fieldName){if(element instanceof websql.schema.Relation)throw new Error("Fields not supported at relations");var column=element.columnsByFieldName[fieldName];if(!column)throw new Error("Unknown field '"+fieldName+"' at table '"+element+"'");return column};
websql.CommandBuilder._resolveAttachedRelation=function(element,relationEndName){var attachedRelation;if(element instanceof websql.schema.Relation)attachedRelation=element.accessor.getConnectionRelation(relationEndName);else attachedRelation=element.attachedRelationsByEndName[relationEndName];if(!attachedRelation)throw new Error("Unknown relation end '"+relationEndName+"' at "+(element instanceof websql.schema.Relation?"relation ":"table ")+element);return attachedRelation};
websql.CommandBuilder._ROWID_ALIAS="rowid";websql.CommandBuilder.prototype.createRelatedBuilder=function(ctor){return new ctor(this.db,this._storeOrRelationName)};exportProperty(websql.CommandBuilder.prototype,"createRelatedBuilder",websql.CommandBuilder.prototype.createRelatedBuilder);
websql.CommandBuilder._Worker=function(schema,storeOrRelationName,noJoins){this._noJoins=noJoins;this._fromBuilder=new websql.query.QueryBuilder;this._whereBuilder=null;this._inputColumns=new websql.ColumnData("input");this._resultColumns=new websql.ColumnData("result");this._orderColumns=new websql.ColumnData("order term");this._limit=null;this._baseDataSet=this._createBaseDataSet(schema,storeOrRelationName);this._dataSetsMap={};this._dataSets=[];this._joined=false;this._joinedToMany=false};
websql.CommandBuilder._Worker.prototype._includeInputField=function(fieldPath,valueParameter){var fieldLocation=this._includeField(fieldPath);this._inputColumns.add(fieldLocation.column,{column:fieldLocation.column,valueParameter:valueParameter})};
websql.CommandBuilder._Worker.prototype._includeOutputField=function(fieldPath,propertyName){var fieldLocation=this._includeField(fieldPath);var alias="o"+this._resultColumns.getSize();this._resultColumns.addSpecific(fieldLocation.column,alias,{dataSet:fieldLocation.dataSet,column:fieldLocation.column,alias:alias,propertyName:propertyName});fieldLocation.dataSet.usedInResults=true};
websql.CommandBuilder._Worker.prototype._includeFilterOnRowid=function(valueParameter){var whereBuilder=this._whereBuilder;if(!whereBuilder)this._whereBuilder=whereBuilder=new websql.query.QueryTemplateBuilder;else whereBuilder.sql("AND");whereBuilder.groupStart("(");this._appendFilterOnRowidTerm(whereBuilder,valueParameter);whereBuilder.groupEnd(")")};
websql.CommandBuilder._Worker.prototype._appendFilterOnRowidTerm=function(targetBuilder,valueParameter){var $jscomp$this=this;var operatorHandler=websql.OperatorHandlers.VALUE[xdata.ValueOperator.IN];var converter=websql.Converters[websql.query.ROWID_COLUMN_TYPE];var leftOperand=function(builder){return builder.quotedName($jscomp$this._baseDataSet.alias||"",websql.query.ROWID_COLUMN_NAME)};var rightOperand={appender:function(builder,index){builder.inputPlaceholder({parameterName:valueParameter,elementIndex:index,
converter:converter})},parameterName:valueParameter,internalOperator:xdata.CollectionOperator.ANY};operatorHandler.appendExpansion(targetBuilder,converter,leftOperand,rightOperand)};websql.CommandBuilder._Worker.prototype._includeFilter=function(expr){var whereBuilder=this._whereBuilder;if(!whereBuilder)this._whereBuilder=whereBuilder=new websql.query.QueryTemplateBuilder;else whereBuilder.sql("AND");whereBuilder.groupStart("(");this._appendFilter(whereBuilder,expr);whereBuilder.groupEnd(")")};
websql.CommandBuilder._Worker.prototype._appendFilter=function(targetBuilder,expr){if(expr.fieldPath)this._appendFilterTerm(targetBuilder,(expr));else this._appendFilterLogicExpression(targetBuilder,(expr))};
websql.CommandBuilder._Worker.prototype._appendFilterLogicExpression=function(targetBuilder,logicExpr){var operatorHandler=websql.OperatorHandlers.LOGIC[(logicExpr.operator)];if(!operatorHandler)throw new Error("Unknown logic operator '"+logicExpr.operator+"'");var operands=logicExpr.operands.map(function(operandExpr){var thisCommandBuilder=this;return function(builder){return thisCommandBuilder._appendFilter(builder,operandExpr)}},this);operatorHandler.appendExpansion(targetBuilder,operands)};
websql.CommandBuilder._Worker.prototype._appendFilterTerm=function(targetBuilder,term){var operatorHandler=websql.OperatorHandlers.VALUE[(term.operator)];if(!operatorHandler)throw new Error("Unknown value operator '"+term.operator+"'");var fieldLocation=this._includeField(term.fieldPath);var leftOperand=function(builder){builder.quotedName(fieldLocation.dataSet.alias||"",fieldLocation.column.name)};var rightOperand=undefined;if(term.valueParameter!==undefined)rightOperand={appender:function(builder,
index){builder.inputPlaceholder({parameterName:term.valueParameter,elementIndex:index,converter:fieldLocation.column.converter})},parameterName:term.valueParameter,internalOperator:(term.internalOperator)};operatorHandler.appendExpansion(targetBuilder,fieldLocation.column.converter,leftOperand,rightOperand)};
websql.CommandBuilder._Worker.prototype._includeOrderTerm=function(term){var fieldLocation=this._includeField(term.fieldPath);this._orderColumns.add(fieldLocation.column,{dataSet:fieldLocation.dataSet,column:fieldLocation.column,descending:term.descending})};
websql.CommandBuilder._Worker.prototype._includeField=function(fieldPath){var CommandBuilder=websql.CommandBuilder;var parsedPath=this._parseFieldPath(fieldPath);var relationEndNames=parsedPath.relationEndNames;var fieldName=parsedPath.fieldName;var closestDataSet=null,closestIndex=-1;for(var i=relationEndNames.length;i>=0;i--){closestDataSet=this._retrieveDataSet(relationEndNames.slice(0,i));if(closestDataSet){closestIndex=i;break}}var column=this._locateFieldColumn(closestDataSet.element,relationEndNames.slice(closestIndex),
fieldName);var dataSet=this._baseDataSet;for(var i=0;i<relationEndNames.length;i++){var attachedRelation=CommandBuilder._resolveAttachedRelation(dataSet.element,relationEndNames[i]);var equivalentColumn=attachedRelation.relation.accessor.getEquivalentColumn(attachedRelation.side,column);if(equivalentColumn){column=equivalentColumn;break}dataSet=this._includeDataSet(relationEndNames.slice(0,i+1))}return{dataSet:dataSet,column:column}};
websql.CommandBuilder._Worker.prototype._locateFieldColumn=function(element,relationEndNames,fieldName){var CommandBuilder=websql.CommandBuilder;if(relationEndNames.length<=0)return CommandBuilder._resolveFieldColumn(element,fieldName);var attachedRelation=CommandBuilder._resolveAttachedRelation(element,relationEndNames[0]);var nextTable=(attachedRelation.side===websql.RelationSide.ONE?attachedRelation.relation.table2:attachedRelation.relation.table1);return this._locateFieldColumn(nextTable,relationEndNames.slice(1),
fieldName)};websql.CommandBuilder._Worker.prototype._parseFieldPath=function(fieldPath){var lastDotIndex=fieldPath.lastIndexOf(".");if(lastDotIndex<0)return{relationEndNames:[],fieldName:fieldPath};return{relationEndNames:fieldPath.substring(0,lastDotIndex).split("."),fieldName:fieldPath.substring(lastDotIndex+1)}};websql.CommandBuilder._Worker.prototype._includeLimit=function(limit){if(this._limit)throw new Error("Limit already added");this._limit={count:limit.count,offset:limit.begin}};
websql.CommandBuilder._Worker.prototype._createBaseDataSet=function(schema,storeOrRelationName){var table=schema.tablesByStoreName[storeOrRelationName];if(table)return this._createBaseTableDataSet(table,table);var relation=schema.relationsByName[storeOrRelationName];if(relation)return this._createBaseTableDataSet(relation,relation.accessor.getBaseTable());throw new Error("Unknown store/relation '"+storeOrRelationName+"'");};
websql.CommandBuilder._Worker.prototype._createBaseTableDataSet=function(element,table){var baseAlias=this._noJoins?null:this._fromBuilder.createAlias("t");this._fromBuilder.quotedName(table.dbName,table.name);if(baseAlias)this._fromBuilder.sql("AS").quotedName(baseAlias);return{element:element,table:table,many:false,alias:baseAlias,usedInResults:false}};
websql.CommandBuilder._Worker.prototype._createJoinedDataSet=function(parentDataSet,relationEndName){var CommandBuilder=websql.CommandBuilder;var parentDataSetAlias=parentDataSet.alias;if(this._noJoins||!parentDataSetAlias)throw new Error("Cannot join more tables");this._joined=true;var attachedRelation=CommandBuilder._resolveAttachedRelation(parentDataSet.element,relationEndName);var relation=attachedRelation.relation;var relationSide=attachedRelation.side;var joinInfo=relation.accessor.appendTableJoin(this._fromBuilder,
relationSide,parentDataSetAlias);var many=parentDataSet.many||joinInfo.many;if(many)this._joinedToMany=true;return{element:joinInfo.table,table:joinInfo.table,many:many,alias:joinInfo.alias,usedInResults:false}};websql.CommandBuilder._Worker.prototype._retrieveDataSet=function(relationEndNames){return this._retrieveOrIncludeDataSet(relationEndNames,false)};websql.CommandBuilder._Worker.prototype._includeDataSet=function(relationEndNames){return(this._retrieveOrIncludeDataSet(relationEndNames,true))};
websql.CommandBuilder._Worker.prototype._retrieveOrIncludeDataSet=function(relationEndNames,join){if(relationEndNames.length<=0)return this._baseDataSet;var dataSetKey=relationEndNames.join(".");var dataSet=this._dataSetsMap[dataSetKey];if(dataSet)return dataSet;else if(!join)return null;var parentDataSet=this._includeDataSet(relationEndNames.slice(0,relationEndNames.length-1));dataSet=this._createJoinedDataSet(parentDataSet,relationEndNames[relationEndNames.length-1]);this._dataSetsMap[dataSetKey]=
dataSet;this._dataSets.push(dataSet);return dataSet};websql.CommandOLD;exportSymbol("websql.CommandOLD",websql.CommandOLD);websql.Connection=function(db,dbConn){this._db=db;this._dbConn=dbConn};exportSymbol("websql.Connection",websql.Connection);websql.Connection.prototype.getDatabase=function(){return this._db};exportProperty(websql.Connection.prototype,"getDatabase",websql.Connection.prototype.getDatabase);
websql.Connection.prototype.createTransaction=function(descr){var db=this._db;var dbConn=this._dbConn;return new Promise(function(resolve,reject){var atomic=descr.atomic;if(atomic===false){resolve(new websql.Transaction(db,dbConn,!descr.readOnly,null));return}websql.runTransaction(db,dbConn,true,function(dbTx){if(!("keepAlive"in dbTx))throw new Error("Transaction atomicity is not supported");if(atomic===true)dbTx["keepAlive"]();else dbTx["keepAlive"](atomic.interval,atomic.backoff);resolve(new websql.Transaction(db,
dbConn,!descr.readOnly,dbTx))},reject)})};exportProperty(websql.Connection.prototype,"createTransaction",websql.Connection.prototype.createTransaction);websql.Converter=function(){};websql.Converter.prototype.sqlType;websql.Converter.prototype.toSQL=function(value){};websql.Converter.prototype.fromSQL=function(value){};websql.Converter.prototype.appendComparableTermExpansion=function(query,termAppender){};websql.Converters={};
websql.Converters[xdata.SimpleType.ARRAYBUFFER]={sqlType:"BLOB",toSQL:function(value){if(!value)return value;var bytes=new Uint8Array(value);var binStr="";for(var i=0,len=bytes.length;i<len;i++)binStr+=String.fromCharCode(bytes[i]);return GLOBAL.btoa(binStr)},fromSQL:function(value){if(value===null||value===undefined)return value;var binStr=GLOBAL.atob(value);var bytes=new Uint8Array(binStr.length);for(var i=0,len=bytes.length;i<len;i++)bytes[i]=binStr.charCodeAt(i);return bytes.buffer},appendComparableTermExpansion:function(query,
termAppender){termAppender(query)}};websql.Converters[xdata.SimpleType.BOOLEAN]={sqlType:"INTEGER",toSQL:function(value){if(value===null||value===undefined)return value;return value?1:0},fromSQL:function(value){if(value===null||value===undefined)return value;return value===1?true:false},appendComparableTermExpansion:function(query,termAppender){termAppender(query)}};
websql.Converters[xdata.SimpleType.DATE]={sqlType:"INTEGER",toSQL:function(value){if(!value)return value;return value.valueOf()},fromSQL:function(value){if(value===null||value===undefined)return value;return new Date(value)},appendComparableTermExpansion:function(query,termAppender){termAppender(query)}};
websql.Converters[xdata.SimpleType.DECIMAL]={sqlType:"TEXT",toSQL:function(value){return value},fromSQL:function(value){return value},appendComparableTermExpansion:function(query,termAppender){query.groupStart("CAST(");termAppender(query);query.sql("AS REAL").groupEnd(")")}};websql.Converters[xdata.SimpleType.INTEGER]={sqlType:"INTEGER",toSQL:function(value){return value},fromSQL:function(value){return value},appendComparableTermExpansion:function(query,termAppender){termAppender(query)}};
websql.Converters[xdata.SimpleType.REAL]={sqlType:"REAL",toSQL:function(value){return value},fromSQL:function(value){return value},appendComparableTermExpansion:function(query,termAppender){termAppender(query)}};websql.Converters[xdata.SimpleType.STRING]={sqlType:"TEXT",toSQL:function(value){return value},fromSQL:function(value){return value},appendComparableTermExpansion:function(query,termAppender){termAppender(query)}};websql.Database=function(version,schema,asyncOpen){this._version=version;this._schema=schema;this._asyncOpen=asyncOpen;this._listeners=new websql.ListenerCollection};exportSymbol("websql.Database",websql.Database);websql.Database.prototype.getSchema=function(){return this._schema};exportProperty(websql.Database.prototype,"getSchema",websql.Database.prototype.getSchema);
websql.Database.prototype.createSession=function(dbName,descr){var $jscomp$this=this;if(!dbName)throw new Error("No database name specified");return this._openDatabase(dbName).then(function(db){var currentVersion=db.version===""?-1:Number(db.version);if(currentVersion!==$jscomp$this._version)throw new xdata.VersionError($jscomp$this._version,currentVersion);return new websql.Connection($jscomp$this,db)})};exportProperty(websql.Database.prototype,"createSession",websql.Database.prototype.createSession);
websql.Database.prototype.upgradeVersion=function(dbName,schemaFactory){var $jscomp$this=this;var thisDb=this;return this._openDatabase(dbName).then(function(db){var currentVersion=db.version===""?-1:Number(db.version);if(currentVersion===$jscomp$this._version)return;var currentProviderSchema=schemaFactory(currentVersion);var currentSchema=websql.schema.Schema.fromProviderSchema(currentProviderSchema);var ddlGenerator=new websql.DDLQueryGenerator(currentSchema,$jscomp$this._schema);var queries=ddlGenerator.generate();
return new Promise(function(resolve,reject){var lastError=null;db.changeVersion(db.version,String($jscomp$this._version),function(dbTx){(function queryLoop(index){if(index<queries.length)websql.executeSql(thisDb,dbTx,queries[index],[],function(tx,result){queryLoop(index+1)},function(tx,e){lastError=websql.createError(e,queries[index])})})(0)},function(e){reject(lastError||websql.createError(e))},resolve)})})};exportProperty(websql.Database.prototype,"upgradeVersion",websql.Database.prototype.upgradeVersion);
websql.Database.prototype._openDatabase=function(dbName){var asyncOpen=this._asyncOpen;return new Promise(function(resolve){var db=websql.InterruptableWebSql.openDatabase(dbName,"",dbName,1*1024*1024);if(!asyncOpen)return resolve(db);var dummyObject={};db.version=dummyObject;function waitForVersion(){if(db.version!==dummyObject)return resolve(db);GLOBAL.setTimeout(waitForVersion,0)}waitForVersion()})};
websql.Database.prototype.compileSelectCommand=function(descr){var builder;if(this._schema.relationsByName[descr.storeOrRelationName])builder=new websql.RelationSelectCommandBuilder(this,descr.storeOrRelationName);else builder=new websql.TableSelectCommandBuilder(this,descr.storeOrRelationName);if(descr.distinct)builder.useDistinct();descr.outputs.forEach(function(output){builder.addOutputField(output.fieldPath,output.propertyName)});if(descr.filter)builder.addFilter(descr.filter);descr.order.forEach(function(term){builder.addOrderTerm(term)});
if(descr.limit)builder.addLimit(descr.limit);return builder.build()};exportProperty(websql.Database.prototype,"compileSelectCommand",websql.Database.prototype.compileSelectCommand);
websql.Database.prototype.compileInsertCommand=function(descr){var builder;if(this._schema.relationsByName[descr.storeOrRelationName])builder=new websql.RelationInsertCommandBuilder(this,descr.storeOrRelationName);else builder=new websql.TableInsertCommandBuilder(this,descr.storeOrRelationName);descr.inserts.forEach(function(insert){builder.addInputField(insert.fieldPath,insert.valueParameter)});descr.outputs.forEach(function(output){builder.addOutputField(output.fieldPath,output.propertyName)});
return builder.build()};exportProperty(websql.Database.prototype,"compileInsertCommand",websql.Database.prototype.compileInsertCommand);websql.Database.prototype.compileInsertCommandOLD=function(descr){var builder;if(this._schema.relationsByName[descr.storeOrRelationName])throw new Error("Relation inserts are not supported");else return(this._compileInsertCommandOLD(descr))};exportProperty(websql.Database.prototype,"compileInsertCommandOLD",websql.Database.prototype.compileInsertCommandOLD);
websql.Database.prototype.compileUpdateCommand=function(descr){var builder;if(this._schema.relationsByName[descr.storeOrRelationName])builder=new websql.RelationUpdateCommandBuilder(this,descr.storeOrRelationName);else builder=new websql.TableUpdateCommandBuilder(this,descr.storeOrRelationName);descr.updates.forEach(function(update){builder.addInputField(update.fieldPath,update.valueParameter)});if(descr.filter)builder.addFilter(descr.filter);descr.outputs.forEach(function(output){builder.addOutputField(output.fieldPath,
output.before,output.propertyName)});return builder.build()};exportProperty(websql.Database.prototype,"compileUpdateCommand",websql.Database.prototype.compileUpdateCommand);websql.Database.prototype.compileUpdateCommandOLD=function(descr){var builder;if(this._schema.relationsByName[descr.storeOrRelationName])throw new Error("Relation updates are not supported");else return(this._compileUpdateCommandOLD(descr))};exportProperty(websql.Database.prototype,"compileUpdateCommandOLD",websql.Database.prototype.compileUpdateCommandOLD);
websql.Database.prototype.compileDeleteCommand=function(descr){var builder;if(this._schema.relationsByName[descr.storeOrRelationName])builder=new websql.RelationDeleteCommandBuilder(this,descr.storeOrRelationName);else builder=new websql.TableDeleteCommandBuilder(this,descr.storeOrRelationName);if(descr.filter)builder.addFilter(descr.filter);descr.outputs.forEach(function(output){builder.addOutputField(output.fieldPath,output.propertyName)});return builder.build()};
exportProperty(websql.Database.prototype,"compileDeleteCommand",websql.Database.prototype.compileDeleteCommand);
websql.Database.prototype._compileInsertCommandOLD=function(source){var schema=this._schema;var table=schema.tablesByStoreName[source.storeOrRelationName];function quote(name){return'"'+name+'"'}var columnsSql="";var valuesSql="";var parameterNames=[];var parameterConvs=[];source.inserts.forEach(function(property,i){var column=table.columnsByFieldName[property.fieldPath];columnsSql+=(i>0?",":"")+quote(column.name);valuesSql+=i>0?",?":"?";parameterNames.push(property.valueParameter);parameterConvs.push(column.converter.toSQL)});
var sql="INSERT INTO "+quote(table.name)+"("+columnsSql+") VALUES ("+valuesSql+")";var resultConv;if(table.keyColumns.length===1&&table.keyColumns[0]===table.rowidAliasColumn)resultConv=function(tx,parameters,result,successCallback,errorCallback){var keys={};keys[table.keyColumns[0].name]=table.keyColumns[0].converter.toSQL(result.insertId);successCallback(keys)};else if(table.keyColumns.length<=0)resultConv=function(tx,parameters,result,successCallback,errorCallback){successCallback({})};else resultConv=
function(tx,parameters,result,successCallback,errorCallback){var columnsSql="";var resultNames=[];var resultConvs=[];table.keyColumns.forEach(function(keyColumn,i){columnsSql+=(i>0?",":"")+quote(keyColumn.name)+" "+"r"+i;resultNames.push(keyColumn.name);resultConvs.push(keyColumn.converter.toSQL)});var sql="SELECT "+columnsSql+" FROM "+quote(table.name)+" WHERE _rowid_ \x3d ?";tx.executeSql(sql,[result.insertId],function(tx,result){var resultRow=result.rows.item(0);var keys={};for(var i=0;i<resultNames.length;i++)keys[resultNames[i]]=
resultConvs[i](resultRow&&resultRow["r"+i]);successCallback(keys)},function(tx,e){errorCallback(new Error("[SQL"+e.code+"]: "+e.message))})};return{sql:sql,parameterNames:parameterNames,parameterConvs:parameterConvs,resultConv:resultConv,isUpdate:false}};
websql.Database.prototype._compileUpdateCommandOLD=function(source){var schema=this._schema;var table=schema.tablesByStoreName[source.storeOrRelationName];function quote(name){return'"'+name+'"'}var setsSql="";var parameterNames=[];var parameterConvs=[];source.updates.forEach(function(property,i){var column=table.columnsByFieldName[property.fieldPath];setsSql+=(i>0?", ":"")+quote(column.name)+" \x3d ?";parameterNames.push(property.valueParameter);parameterConvs.push(column.converter.toSQL)});var filterByKeyColumnsOnly=
null;var keyColumnsParamenterNames={};var exprSql=source.filter?compileFilter(source.filter):null;function compileFilter(expr){if(expr.fieldPath){var column=table.columnsByFieldName[expr.fieldPath];if(column.key){keyColumnsParamenterNames[column.name]=expr.valueParameter;if(filterByKeyColumnsOnly===null)filterByKeyColumnsOnly=true}else filterByKeyColumnsOnly=false;parameterNames.push(expr.valueParameter);parameterConvs.push(column.converter.toSQL);var valueOperatorHandler=websql.Database._VALUE_OPERATOR_HANDLERS[expr.operator];
return valueOperatorHandler(quote(column.name),"?")}var logicOperatorHandler=websql.Database._LOGIC_OPERATOR_HANDLERS[expr.operator];return logicOperatorHandler(expr.operands.map(compileFilter))}var sql="UPDATE "+quote(table.name)+" SET "+setsSql+(exprSql?" WHERE "+exprSql:"");var resultConv;if(filterByKeyColumnsOnly===true)resultConv=function(tx,parameters,result,successCallback,errorCallback){var keys={};table.keyColumns.forEach(function(keyColumn){var keyParameterValue=parameters[keyColumnsParamenterNames[keyColumn.name]];
keys[keyColumn.name]=keyColumn.converter.toSQL(keyParameterValue)});successCallback([keys])};else resultConv=function(tx,parameters,result,successCallback,errorCallback){errorCallback(new Error("The result of an update requires filtering and only on the key properties"))};return{sql:sql,parameterNames:parameterNames,parameterConvs:parameterConvs,resultConv:resultConv,isUpdate:true}};
websql.Database._LOGIC_OPERATOR_HANDLERS=function(){var LogicOperator=xdata.LogicOperator;var map={};map[LogicOperator.NOT]=function(only){return"NOT ("+only+")"};map[LogicOperator.AND]=function(){return"("+Array.prototype.join.call(arguments,") AND (")+")"};map[LogicOperator.OR]=function(){return"("+Array.prototype.join.call(arguments,") OR (")+")"};return map}();
websql.Database._VALUE_OPERATOR_HANDLERS=function(){var ValueOperator=xdata.ValueOperator;function unsupported(){throw new Error("Operator not supported");}var map={};map[ValueOperator.EMPTY]=function(only){return unsupported()};map[ValueOperator.NOT_EMPTY]=function(only){return unsupported()};map[ValueOperator.NULL]=function(only){return unsupported()};map[ValueOperator.NOT_NULL]=function(only){return unsupported()};map[ValueOperator.IN]=function(left,right){return unsupported()};map[ValueOperator.NOT_IN]=
function(left,right){return unsupported()};map[ValueOperator.EQUAL]=function(left,right){return left+" \x3d "+right};map[ValueOperator.EQUAL_IGNORE_CASE]=function(left,right){return unsupported()};map[ValueOperator.NOT_EQUAL]=function(left,right){return left+" \x3c\x3e "+right};map[ValueOperator.NOT_EQUAL_IGNORE_CASE]=function(left,right){return unsupported()};map[ValueOperator.GREATER]=function(left,right){return unsupported()};map[ValueOperator.GREATER_OR_EQUAL]=function(left,right){return unsupported()};
map[ValueOperator.LESSER]=function(left,right){return unsupported()};map[ValueOperator.LESSER_OR_EQUAL]=function(left,right){return unsupported()};map[ValueOperator.BEGINNING]=function(left,right){return unsupported()};map[ValueOperator.BEGINNING_IGNORE_CASE]=function(left,right){return unsupported()};map[ValueOperator.NOT_BEGINNING]=function(left,right){return unsupported()};map[ValueOperator.NOT_BEGINNING_IGNORE_CASE]=function(left,right){return unsupported()};map[ValueOperator.CONTAINING]=function(left,
right){return unsupported()};map[ValueOperator.CONTAINING_IGNORE_CASE]=function(left,right){return unsupported()};map[ValueOperator.NOT_CONTAINING]=function(left,right){return unsupported()};map[ValueOperator.NOT_CONTAINING_IGNORE_CASE]=function(left,right){return unsupported()};map[ValueOperator.ENDING]=function(left,right){return unsupported()};map[ValueOperator.ENDING_IGNORE_CASE]=function(left,right){return unsupported()};map[ValueOperator.NOT_ENDING]=function(left,right){return unsupported()};
map[ValueOperator.NOT_ENDING_IGNORE_CASE]=function(left,right){return unsupported()};return map}();websql.Database.prototype.attachSession=function(lowLevelConn){var dbConn=(lowLevelConn);return new websql.Connection(this,dbConn)};exportProperty(websql.Database.prototype,"attachSession",websql.Database.prototype.attachSession);websql.Database.prototype.attachTransaction=function(lowLevelTx){var dbConn=(null);var dbTx=(lowLevelTx);return new websql.Transaction(this,dbConn,true,dbTx)};
exportProperty(websql.Database.prototype,"attachTransaction",websql.Database.prototype.attachTransaction);websql.Database.prototype.addListener=function(listener){this._listeners.add(listener)};exportProperty(websql.Database.prototype,"addListener",websql.Database.prototype.addListener);websql.Database.prototype.removeListener=function(listener){this._listeners.remove(listener)};exportProperty(websql.Database.prototype,"removeListener",websql.Database.prototype.removeListener);
websql.Database.prototype.getListeners=function(){return this._listeners};exportProperty(websql.Database.prototype,"getListeners",websql.Database.prototype.getListeners);websql.DDLQueryGenerator=function(oldSchema,newSchema){this._oldSchema=oldSchema;this._newSchema=newSchema;this._queryBuilders=null;this._cleanupQueryBuilders=null;this._newBridgeTablesTuples=null;this._newTablesTupleJoins=null;this._tableChangedIndexes=null};
websql.DDLQueryGenerator.prototype.generate=function(){var schemaDiff=this._computeSchemaDiff();if(!schemaDiff)return[];this._initGenerationState();try{this._collectChangedIndexes(schemaDiff);this._generateRelations(schemaDiff);this._generateTablesAndIndexes(schemaDiff);return this._queryBuilders.map(function(builder){return builder.buildSQL()}).concat(this._cleanupQueryBuilders.map(function(builder){return builder.buildSQL()}))}finally{this._clearGenerationState()}};
websql.DDLQueryGenerator.prototype._initGenerationState=function(){this._queryBuilders=[];this._cleanupQueryBuilders=[];this._newBridgeTablesTuples={};this._newTablesTupleJoins={};this._tableChangedIndexes={}};websql.DDLQueryGenerator.prototype._clearGenerationState=function(){this._queryBuilders=null;this._cleanupQueryBuilders=null;this._newBridgeTablesTuples=null;this._newTablesTupleJoins=null;this._tableChangedIndexes=null};
websql.DDLQueryGenerator.prototype._addQuery=function(){var builder=new websql.query.QueryBuilder;this._queryBuilders.push(builder);return builder};websql.DDLQueryGenerator.prototype._addCleanupQuery=function(){var builder=new websql.query.QueryBuilder;this._cleanupQueryBuilders.unshift(builder);return builder};websql.DDLQueryGenerator._SchemaDiff;
websql.DDLQueryGenerator.prototype._computeSchemaDiff=function(){var oldTables=this._oldSchema.tables;var oldRelations=this._oldSchema.relations;var oldIndexes=this._oldSchema.indexes;var newTables=this._newSchema.tables;var newRelations=this._newSchema.relations;var newIndexes=this._newSchema.indexes;var schemaChanged=false;var changedRelationDiffs=[];var relationRawDiff=websql.util.computeObjectsDiff(oldRelations,newRelations,this._getRelationIdentityKey.bind(this));relationRawDiff.replaced.forEach(function(replacement){if(replacement.older.length>
1||replacement.newer.length>1)throw new Error("A new relation can replace exactly one old relation");var relationDiff=this._computeRelationDiff(replacement.older[0],replacement.newer[0]);if(relationDiff){changedRelationDiffs.push(relationDiff);schemaChanged=true}},this);var changedTableDiffs=[];var tableRawDiff=websql.util.computeObjectsDiff(oldTables,newTables,this._getTableIdentityKey.bind(this));if(tableRawDiff.added.length>0||tableRawDiff.removed.length>0)schemaChanged=true;tableRawDiff.replaced.forEach(function(replacement){if(replacement.older.length>
1||replacement.newer.length>1)throw new Error("A new table can replace exactly one old table");var tableDiff=this._computeTableDiff(replacement.older[0],replacement.newer[0]);if(tableDiff){changedTableDiffs.push(tableDiff);schemaChanged=true}},this);var changedIndexDiffs=[];var indexRawDiff=websql.util.computeObjectsDiff(oldIndexes,newIndexes,this._getIndexIdentityKey.bind(this));if(indexRawDiff.added.length>0||indexRawDiff.removed.length>0)schemaChanged=true;indexRawDiff.replaced.forEach(function(replacement){if(replacement.older.length>
1||replacement.newer.length>1)throw new Error("A new index can replace exactly one old index");var indexDiff=this._computeIndexDiff(replacement.older[0],replacement.newer[0]);if(indexDiff){changedIndexDiffs.push(indexDiff);schemaChanged=true}},this);if(schemaChanged)return{addedTables:tableRawDiff.added.slice(),removedTables:tableRawDiff.removed.slice(),changedTables:changedTableDiffs,changedRelations:changedRelationDiffs,addedIndexes:indexRawDiff.added.slice(),removedIndexes:indexRawDiff.removed.slice(),
changedIndexes:changedIndexDiffs};return null};websql.DDLQueryGenerator._RelationDiff;websql.DDLQueryGenerator.prototype._computeRelationDiff=function(oldRelation,newRelation){if(newRelation.accessor&&!oldRelation.accessor.hasSameStructure(newRelation.accessor))return{oldRelation:oldRelation,newRelation:newRelation};return null};websql.DDLQueryGenerator._TableDiff;
websql.DDLQueryGenerator.prototype._computeTableDiff=function(oldTable,newTable){var tableChanged=oldTable.name!==newTable.name;var columnIdentity={older:[],newer:[]};var columnRawDiff=websql.util.computeObjectsDiff(oldTable.columns,newTable.columns,this._getColumnIdentityKey.bind(this));if(columnRawDiff.added.length>0||columnRawDiff.removed.length>0)tableChanged=true;columnRawDiff.replaced.forEach(function(replacement){if(replacement.older.length>1)throw new Error("New columns can replace exactly at most one column");
var oldColumn=replacement.older[0];tableChanged=tableChanged||this._computeColumnDiff(oldColumn,replacement.newer);replacement.newer.forEach(function(newColumn){columnIdentity.older.push(oldColumn);columnIdentity.newer.push(newColumn)},this)},this);var foreignKeyRawDiff=websql.util.computeObjectsDiff(oldTable.foreignKeys,newTable.foreignKeys,this._getForeignKeyIdentityKey.bind(this));if(foreignKeyRawDiff.added.length>0||foreignKeyRawDiff.removed.length>0)tableChanged=true;foreignKeyRawDiff.replaced.forEach(function(replacement){if(replacement.older.length>
1||replacement.newer.length>1)throw new Error("A new foreign key can replace exactly one old foreign key");tableChanged=tableChanged||this._computeForeignKeyDiff(replacement.older[0],replacement.newer[0])},this);if(tableChanged)return{oldTable:oldTable,newTable:newTable,columnIdentity:columnIdentity};return null};
websql.DDLQueryGenerator.prototype._computeColumnDiff=function(oldColumn,newColumns){if(newColumns.length>1)return true;var newColumn=newColumns[0];return newColumn.name!==oldColumn.name||newColumn.type!==oldColumn.type||newColumn.key!==oldColumn.key};
websql.DDLQueryGenerator.prototype._computeForeignKeyDiff=function(oldForeignKey,newForeignKey){var foreignKeyChanged=false;var columnRawDiff=websql.util.computeObjectsDiff(oldForeignKey.columns,newForeignKey.columns,this._getColumnIdentityKey.bind(this));if(columnRawDiff.added.length>0||columnRawDiff.removed.length>0)foreignKeyChanged=true;columnRawDiff.replaced.forEach(function(replacement){if(replacement.older.length>1)throw new Error("New columns can replace exactly at most one column");var oldColumn=
replacement.older[0];foreignKeyChanged=foreignKeyChanged||this._computeColumnDiff(oldColumn,replacement.newer)},this);if(!!this._computeTableDiff(oldForeignKey.referencedTable,newForeignKey.referencedTable))foreignKeyChanged=true;return foreignKeyChanged};websql.DDLQueryGenerator._IndexDiff;
websql.DDLQueryGenerator.prototype._computeIndexDiff=function(oldIndex,newIndex){var indexChanged=oldIndex.name!==newIndex.name||oldIndex.unique!==newIndex.unique;if(!!this._computeTableDiff(oldIndex.table,newIndex.table))indexChanged=true;var columnRawDiff=websql.util.computeObjectsDiff(oldIndex.columns,newIndex.columns,this._getColumnIdentityKey.bind(this));if(columnRawDiff.added.length>0||columnRawDiff.removed.length>0)indexChanged=true;columnRawDiff.replaced.forEach(function(replacement){if(replacement.older.length>
1)throw new Error("New columns can replace exactly at most one column");var oldColumn=replacement.older[0];indexChanged=indexChanged||this._computeColumnDiff(oldColumn,replacement.newer)},this);if(indexChanged)return{oldIndex:oldIndex,newIndex:newIndex};return null};websql.DDLQueryGenerator.prototype._generateRelations=function(schemaDiff){schemaDiff.changedRelations.forEach(this._generateRelationTuplesTable,this)};
websql.DDLQueryGenerator.prototype._generateRelationTuplesTable=function(relationDiff){var oldRelation=relationDiff.oldRelation;var newRelation=relationDiff.newRelation;var newTable1=(newRelation.table1);var newTable2=(newRelation.table2);var tuplesTableInfo=this._newSchema.createBridgeTable("_tuples_"+newRelation.name,"temp",[],newTable1,newTable2,{},{});var tuplesTable=tuplesTableInfo.table;var createQuery=this._addQuery().sql("CREATE TABLE").quotedName(tuplesTable.dbName,tuplesTable.name);this._appendTableDefinition(createQuery,
tuplesTable);var insertQuery=this._addQuery().sql("INSERT INTO").quotedName(tuplesTable.dbName,tuplesTable.name);this._appendTargetColumnsList(insertQuery,tuplesTable.columns);oldRelation.accessor.appendTupleSelection(insertQuery,newRelation.accessor.getUniqueSide());this._addCleanupQuery().sql("DROP TABLE").quotedName(tuplesTable.dbName,tuplesTable.name);if(newRelation.accessor instanceof websql.RelationAccessor.Bridged){var newBridgeTable=newRelation.accessor.getBridgeTable();if(DEBUG&&tuplesTable.columns.length!==
newBridgeTable.columns.length)throw new Error("Tuples table and bridge table have different columns");this._newBridgeTablesTuples[newBridgeTable.name]=tuplesTable}else if(newRelation.accessor instanceof websql.RelationAccessor.Collapsed){var collapsedTable=newRelation.accessor.getCollapsedTable();var collapsedSide,tuplesTableFkCols,tuplesTableOtherFkCols;if(newRelation.table1===collapsedTable){collapsedSide=websql.RelationSide.ONE;tuplesTableFkCols=tuplesTableInfo.fkCols1;tuplesTableOtherFkCols=tuplesTableInfo.fkCols2}else if(newRelation.table2===
collapsedTable){collapsedSide=websql.RelationSide.TWO;tuplesTableFkCols=tuplesTableInfo.fkCols2;tuplesTableOtherFkCols=tuplesTableInfo.fkCols1}else if(DEBUG)throw new Error("Invalid collapsed table");var joins=this._newTablesTupleJoins[collapsedTable.name];if(!joins)this._newTablesTupleJoins[collapsedTable.name]=joins=[];joins.push({relation:newRelation,side:collapsedSide,table:tuplesTable,fkCols:tuplesTableFkCols,otherFkCols:tuplesTableOtherFkCols})}else if(DEBUG)throw new Error("Unknown relation accessor type");
};
websql.DDLQueryGenerator.prototype._collectChangedIndexes=function(schemaDiff){var tableChangedIndexes=this._tableChangedIndexes;function getOrCreate(table){var changes=tableChangedIndexes[table.name];if(!changes)tableChangedIndexes[table.name]=changes={added:[],removed:[]};return changes}schemaDiff.addedIndexes.forEach(function(newIndex){getOrCreate(newIndex.table).added.push(newIndex)},this);schemaDiff.removedIndexes.forEach(function(oldIndex){getOrCreate(oldIndex.table).removed.push(oldIndex)},this);
schemaDiff.changedIndexes.forEach(function(indexDiff){getOrCreate(indexDiff.oldIndex.table).removed.push(indexDiff.oldIndex);getOrCreate(indexDiff.newIndex.table).added.push(indexDiff.newIndex)},this)};
websql.DDLQueryGenerator.prototype._generateTablesAndIndexes=function(schemaDiff){var tableChangedIndexes=this._tableChangedIndexes||{};function getIndexChanges(tableName){var changes=tableChangedIndexes[tableName];return changes||{added:[],removed:[]}}var affectedTables={};schemaDiff.addedTables.forEach(function(newTable){this._generateTableAddition(newTable,getIndexChanges(newTable.name).added);affectedTables[newTable.name]=true},this);schemaDiff.changedTables.forEach(function(tableDiff){this._generateTableUpdate(tableDiff,
getIndexChanges(tableDiff.oldTable.name).removed,getIndexChanges(tableDiff.newTable.name).added);affectedTables[tableDiff.oldTable.name]=true;affectedTables[tableDiff.newTable.name]=true},this);schemaDiff.removedTables.forEach(function(oldTable){this._generateTableRemoval(oldTable,getIndexChanges(oldTable.name).removed);affectedTables[oldTable.name]=true},this);Object.keys(tableChangedIndexes).forEach(function(tableName){if(affectedTables[tableName]===true)return;var indexChanges=getIndexChanges(tableName);
this._generateTableIndexesOnly(indexChanges.removed,indexChanges.added)},this)};
websql.DDLQueryGenerator.prototype._generateTableAddition=function(newTable,newAddedIndexes){var query=this._addQuery().sql("CREATE TABLE").quotedName(newTable.dbName,newTable.name);this._appendTableDefinition(query,newTable);newAddedIndexes.forEach(this._generateIndexAddition,this);var tuplesTable=this._newBridgeTablesTuples[newTable.name];if(tuplesTable){var insertQuery=this._addQuery().sql("INSERT INTO").quotedName(newTable.dbName,newTable.name);this._appendTargetColumnsList(insertQuery,newTable.columns);
insertQuery.sql("SELECT");this._appendResultColumnsList(insertQuery,tuplesTable.columns);insertQuery.sql("FROM").quotedName(tuplesTable.dbName,tuplesTable.name)}};
websql.DDLQueryGenerator.prototype._generateTableUpdate=function(tableDiff,oldRemovedIndexes,newAddedIndexes){var oldTable=tableDiff.oldTable;var newTable=tableDiff.newTable;var tupleJoins=this._newTablesTupleJoins[newTable.name]||[];var tempTableName="_new_"+newTable.name;var createQuery=this._addQuery().sql("CREATE TABLE").quotedName(newTable.dbName,tempTableName);this._appendTableDefinition(createQuery,newTable);var targetColumns=tableDiff.columnIdentity.newer.slice();tupleJoins.forEach(function(join,
i){Array.prototype.push.apply(targetColumns,join.relation.accessor.getCollapsedColumns())},this);var selectResultColumns=tableDiff.columnIdentity.older.slice();selectResultColumns=(selectResultColumns);tupleJoins.forEach(function(join,i){var tableAlias="t"+i;join.otherFkCols.forEach(function(col){selectResultColumns.push({tableAlias:tableAlias,column:col})},this)},this);var insertQuery=this._addQuery().sql("INSERT INTO").quotedName(newTable.dbName,tempTableName);this._appendTargetColumnsList(insertQuery,
targetColumns);insertQuery.sql("SELECT");this._appendResultColumnsList(insertQuery,selectResultColumns);insertQuery.sql("FROM").quotedName(oldTable.dbName,oldTable.name);tupleJoins.forEach(function(join,i){var accessor=join.relation.accessor;accessor.appendKeyImportJoin(insertQuery,join.side,join.table,"t"+i,join.fkCols)},this);this._addQuery().sql("DROP TABLE").quotedName(oldTable.dbName,oldTable.name);this._addQuery().sql("ALTER TABLE").quotedName(newTable.dbName,tempTableName).sql("RENAME TO").quotedName(newTable.name);
newAddedIndexes.forEach(this._generateIndexAddition,this)};websql.DDLQueryGenerator.prototype._generateTableRemoval=function(oldTable,oldRemovedIndexes){this._addQuery().sql("DROP TABLE").quotedName(oldTable.dbName,oldTable.name)};websql.DDLQueryGenerator.prototype._generateTableIndexesOnly=function(removedIndexes,addedIndexes){removedIndexes.forEach(this._generateIndexRemoval,this);addedIndexes.forEach(this._generateIndexAddition,this)};
websql.DDLQueryGenerator.prototype._generateIndexAddition=function(newIndex){var query=this._addQuery().sql(newIndex.unique?"CREATE UNIQUE INDEX":"CREATE INDEX");query.quotedName(newIndex.table.dbName,newIndex.name);query.sql("ON").quotedName(newIndex.table.name);this._appendTargetColumnsList(query,newIndex.columns)};websql.DDLQueryGenerator.prototype._generateIndexRemoval=function(oldIndex){this._addQuery().sql("DROP INDEX").quotedName(oldIndex.table.dbName,oldIndex.name)};
websql.DDLQueryGenerator.prototype._appendTableDefinition=function(query,table){query.groupStart("(\n  ");table.columns.forEach(function(column){this._appendColumnDefinition(query,column);query.separator(",\n  ")},this);this._appendTableConstraints(query,table);query.groupEnd("\n)")};websql.DDLQueryGenerator.prototype._appendColumnDefinition=function(query,column){query.quotedName(column.name);query.sql(column.type)};
websql.DDLQueryGenerator.prototype._appendTableConstraints=function(query,table){var keyColumns=table.keyColumns;if(keyColumns.length>0){query.sql("PRIMARY KEY").groupStart("(");keyColumns.forEach(function(keyColumn){query.quotedName(keyColumn.name);query.separator(", ")});query.groupEnd(")")}query.separator(",\n  ");table.foreignKeys.forEach(function(foreignKey){query.sql("FOREIGN KEY").groupStart("(");foreignKey.columns.forEach(function(fkColumn){query.quotedName(fkColumn.name);query.separator(", ")});
query.groupEnd(")");query.sql("REFERENCES").quotedName(foreignKey.referencedTable.dbName,foreignKey.referencedTable.name);query.groupStart("(");foreignKey.referencedColumns.forEach(function(refColumn){query.quotedName(refColumn.name);query.separator(", ")});query.groupEnd(")");query.separator(",\n  ")},this)};
websql.DDLQueryGenerator.prototype._appendTargetColumnsList=function(query,columns){query.groupStart("(");columns.forEach(function(column){if(column.tableAlias)query.quotedName(column.tableAlias,column.column.name);else query.quotedName(column.name);query.separator(", ")});query.groupEnd(")")};
websql.DDLQueryGenerator.prototype._appendResultColumnsList=function(query,columns){query.groupStart();columns.forEach(function(column){if(column.tableAlias)query.quotedName(column.tableAlias,column.column.name);else query.quotedName(column.name);query.separator(", ")});query.groupEnd()};websql.DDLQueryGenerator.prototype._getTableIdentityKey=function(table){return table.identities};websql.DDLQueryGenerator.prototype._getColumnIdentityKey=function(column){return column.identities};
websql.DDLQueryGenerator.prototype._getRelationIdentityKey=function(relation){return relation.identities};websql.DDLQueryGenerator.prototype._getForeignKeyIdentityKey=function(foreignKey){return foreignKey.identities};websql.DDLQueryGenerator.prototype._getIndexIdentityKey=function(index){return index.identities};websql.InterruptableWebSql={};
websql.InterruptableWebSql.openDatabase=function(){var dbContexts={};function retrieveDbContext(dbName){var dbContext=dbContexts[dbName];if(!dbContext){dbContext={requestedTxs:0};dbContexts[dbName]=dbContext}return dbContext}function createContext(dbContext,realTxFactory,canYield){return{dbContext:dbContext,realTxFactory:realTxFactory,canYield:canYield,realTx:null,callbackDepth:0,activeQueries:0,queuedQueries:[],pollerRunning:false,keepAlive:false,yieldTimer:null,yielding:false}}var INSTRUMENTED=
"__instrumented_"+Math.random();websql.installOpenDatabaseCache();var _openDatabase=GLOBAL.openDatabase;function openDatabaseInterruptable(name,version,description,size,dbCallback){if(!_openDatabase)_openDatabase=GLOBAL.openDatabase;var db=_openDatabase.call(GLOBAL,name,version,description,size,dbCallback);if(db[INSTRUMENTED]===true)return db;Object.defineProperty(db,INSTRUMENTED,{value:true});var dbContext=retrieveDbContext(name);var _transactionFactory=db.transaction.bind(db);var _readTransactionFactory=
db.readTransaction.bind(db);function transactionInterruptable(txCallback,errorCallback,successCallback){var context=createContext(dbContext,_transactionFactory,true);return constructTransaction(context,txCallback,errorCallback,successCallback)}function readTransactionInterruptable(txCallback,errorCallback,successCallback){var context=createContext(dbContext,_readTransactionFactory,false);return constructTransaction(context,txCallback,errorCallback,successCallback)}db.transaction=transactionInterruptable;
db.readTransaction=readTransactionInterruptable;return db}function constructTransaction(context,txCallback,errorCallback,successCallback){var dbContext=context.dbContext;var requestPending=true;dbContext.requestedTxs++;function handleFinishedCreation(){if(!requestPending)return;requestPending=false;dbContext.requestedTxs--}return context.realTxFactory(function(tx){handleFinishedCreation();context.realTx=tx;context.callbackDepth++;try{return txCallback.call(this,wrapTx(context))}finally{context.callbackDepth--;
handleCallbackTermination(context)}},function(){handleFinishedCreation();if(errorCallback)return errorCallback.apply(this,arguments)},successCallback)}function wrapTx(context,dontQueue){return new InterruptableSQLTransaction(context,dontQueue)}function InterruptableSQLTransaction(context,dontQueue){this._context=context;this._dontQueue=dontQueue}InterruptableSQLTransaction.prototype.executeSql=function(sql,args,callback,errorCallback){var context=this._context;var dontQueue=this._dontQueue;var tx=
context.realTx;if(!tx||context.keepAlive&&context.callbackDepth<=0&&!dontQueue){context.queuedQueries.push([sql,args,callback,errorCallback]);return}context.activeQueries++;return tx.executeSql(sql,args,function(innerTx,resultSet){context.activeQueries--;try{if(callback){context.callbackDepth++;try{return callback.call(this,wrapTx(context),resultSet)}finally{context.callbackDepth--}}}finally{handleCallbackTermination(context)}},function(innerTx,error){context.activeQueries--;try{if(errorCallback){context.callbackDepth++;
try{return errorCallback.call(this,wrapTx(context),error)}finally{context.callbackDepth--}}}finally{handleCallbackTermination(context)}})};InterruptableSQLTransaction.prototype.keepAlive=function(yieldInterval,yieldBackoffTime){var context=this._context;if(context.callbackDepth<=0)throw new Error("Keep alive called too late");yieldInterval=yieldInterval||0;yieldBackoffTime=yieldBackoffTime||0;context.keepAlive=true;if(context.yieldTimer)window.clearInterval(context.yieldTimer);if(yieldInterval>0)context.yieldTimer=
window.setInterval(doYield.bind(this,context,yieldBackoffTime),yieldInterval);else context.yieldTimer=null};InterruptableSQLTransaction.prototype.yield=function(backoffTime){doYield(this._context,backoffTime)};InterruptableSQLTransaction.prototype.release=function(){var context=this._context;context.keepAlive=false;if(context.yieldTimer)window.clearInterval(context.yieldTimer);context.yieldTimer=null;stopPoller(context)};function doYield(context,backoffTime){var dbContext=context.dbContext;if(context.yielding||
(!context.canYield||dbContext.requestedTxs<=0))return;context.realTx=null;context.yielding=true;stopPoller(context);window.setTimeout(function(){constructTransaction(context,function(){context.yielding=false})},backoffTime||0)}function handleCallbackTermination(context){var tx=context.realTx;if(tx&&context.keepAlive&&context.callbackDepth<=0&&context.activeQueries<=0)startPoller(context);else stopPoller(context)}function startPoller(context){if(context.pollerRunning)return;context.pollerRunning=true;
executePoller(context)}function stopPoller(context){context.pollerRunning=false}function executePoller(context){var tx=context.realTx;if(!context.pollerRunning)return;tx.executeSql("SELECT '$polling'",[],function(innerTx,resultSet){context.callbackDepth++;try{executeQueuedQueries(context)}finally{context.callbackDepth--;handleCallbackTermination(context)}executePoller(context)},function(innerTx,error){console.error("Poller failed")})}function executeQueuedQueries(context){if(context.queuedQueries.length<=
0)return;var queries=context.queuedQueries;context.queuedQueries=[];var tx=wrapTx(context,true);for(var i=0;i<queries.length;i++)tx.executeSql.apply(tx,queries[i])}return openDatabaseInterruptable}();websql.InterruptableWebSql._DbContext;websql.InterruptableWebSql._Context;websql.ListenerCollection=function(){this._listeners=[]};websql.ListenerCollection.prototype.add=function(listener){this._listeners.push(listener)};websql.ListenerCollection.prototype.remove=function(listener){for(var i=0;i<this._listeners.length;i++)if(this._listeners[i]===listener){this._listeners.splice(i,1);return}};websql.ListenerCollection.prototype.notifyBegunTransaction=function(writeEnabled){this._notify("begunTransaction",{readOnly:!writeEnabled})};
websql.ListenerCollection.prototype.notifyResolvedTransaction=function(writeEnabled,committed){this._notify("resolvedTransaction",{readOnly:!writeEnabled,committed:committed})};websql.ListenerCollection.prototype.notifyExecutingSql=function(sql,sqlParams){this._notify("executingCommand",{command:sql,commandParameters:sqlParams||[]})};
websql.ListenerCollection.prototype.notifyExecutedSql=function(sql,sqlParams,error){this._notify("executedCommand",{command:sql,commandParameters:sqlParams||[],commandError:error?error.message:null})};websql.ListenerCollection.prototype._notify=function(methodName,event){for(var i=0;i<this._listeners.length;i++){var listener=this._listeners[i];listener[methodName](event)}};websql.LogicOperatorHandler=function(){};exportSymbol("websql.LogicOperatorHandler",websql.LogicOperatorHandler);websql.LogicOperatorHandler.prototype.appendExpansion=function(query,operands){};exportProperty(websql.LogicOperatorHandler.prototype,"appendExpansion",websql.LogicOperatorHandler.prototype.appendExpansion);websql.LogicOperatorHandler.Unary=function(operatorSQL){this._prefix=operatorSQL+" ("};exportProperty(websql.LogicOperatorHandler,"Unary",websql.LogicOperatorHandler.Unary);
websql.LogicOperatorHandler.Unary.prototype.appendExpansion=function(query,operands){if(DEBUG&&operands.length!==1)throw new Error("Only one operand is supported");query.sql(this._prefix).sql(operands[0](query)).sql(")")};exportProperty(websql.LogicOperatorHandler.Unary.prototype,"appendExpansion",websql.LogicOperatorHandler.Unary.prototype.appendExpansion);websql.LogicOperatorHandler.Binary=function(operatorSQL){this._infix=") "+operatorSQL+" ("};
exportProperty(websql.LogicOperatorHandler,"Binary",websql.LogicOperatorHandler.Binary);websql.LogicOperatorHandler.Binary.prototype.appendExpansion=function(query,operandAppenders){query.groupStart("(");for(var i=0;i<operandAppenders.length;i++){operandAppenders[i](query);query.separator(this._infix)}query.groupEnd(")")};exportProperty(websql.LogicOperatorHandler.Binary.prototype,"appendExpansion",websql.LogicOperatorHandler.Binary.prototype.appendExpansion);websql.SelectCommand=function(){websql.Command.call(this)};extendConstructor(websql.SelectCommand,websql.Command);exportSymbol("websql.SelectCommand",websql.SelectCommand);websql.SelectCommand.prototype.execute=function(tx,parameters,callback,errorCallback){var objects=[];this.executeScan(tx,parameters,objects.push.bind(objects),function(){return callback(objects)},errorCallback)};exportProperty(websql.SelectCommand.prototype,"execute",websql.SelectCommand.prototype.execute);
websql.SelectCommand.prototype.executeScan=ABSTRACT_METHOD;websql.NormalSelectCommand=function(queryTemplate,assemblerFactory){websql.SelectCommand.call(this);this._queryTemplate=queryTemplate;this._assemblerFactory=assemblerFactory};extendConstructor(websql.NormalSelectCommand,websql.SelectCommand);exportSymbol("websql.NormalSelectCommand",websql.NormalSelectCommand);
websql.NormalSelectCommand.prototype.executeScan=function(tx,parameters,scanCallback,callback,errorCallback){var $jscomp$this=this;var query=this._queryTemplate.expand(parameters);this.executeQuery(tx,query,parameters,function(tx,result){$jscomp$this._scanObjects(result,$jscomp$this._assemblerFactory.createAssembler(),scanCallback);callback()},websql.createErrorCallback(errorCallback))};exportProperty(websql.NormalSelectCommand.prototype,"executeScan",websql.NormalSelectCommand.prototype.executeScan);
websql.NormalSelectCommand.prototype._scanObjects=function(result,assembler,scanCallback){var rows=result.rows;for(var i=0;i<rows.length;i++){var row=rows.item(i);var object=assembler((row));if(object)scanCallback(object)}};websql.NormalSelectCommand.prototype.computeExpectedInputCount=function(parameters){return this._queryTemplate.expand(parameters).inputData.length};exportProperty(websql.NormalSelectCommand.prototype,"computeExpectedInputCount",websql.NormalSelectCommand.prototype.computeExpectedInputCount);websql.WriteCommand=function(){websql.Command.call(this)};extendConstructor(websql.WriteCommand,websql.Command);exportSymbol("websql.WriteCommand",websql.WriteCommand);websql.NormalWriteCommand=function(queryTemplate){websql.WriteCommand.call(this);this._queryTemplate=queryTemplate};extendConstructor(websql.NormalWriteCommand,websql.WriteCommand);exportSymbol("websql.NormalWriteCommand",websql.NormalWriteCommand);websql.NormalWriteCommand.prototype.execute=function(tx,parameters,callback,errorCallback){var query=this._queryTemplate.expand(parameters);this.executeQuery(tx,query,parameters,function(tx,result){callback(result.rowsAffected)},websql.createErrorCallback(errorCallback))};
exportProperty(websql.NormalWriteCommand.prototype,"execute",websql.NormalWriteCommand.prototype.execute);websql.NormalWriteCommand.prototype.computeExpectedInputCount=function(parameters){return this._queryTemplate.expand(parameters).inputData.length};exportProperty(websql.NormalWriteCommand.prototype,"computeExpectedInputCount",websql.NormalWriteCommand.prototype.computeExpectedInputCount);websql.ValueOperatorHandler=function(){};exportSymbol("websql.ValueOperatorHandler",websql.ValueOperatorHandler);websql.ValueOperatorHandler.prototype.appendExpansion=function(query,converter,leftOperandAppender,rightOperand){};exportProperty(websql.ValueOperatorHandler.prototype,"appendExpansion",websql.ValueOperatorHandler.prototype.appendExpansion);websql.ValueOperatorHandler.Unary=function(prefixSQL,suffixSQL){this._prefixSQL=prefixSQL;this._suffixSQL=suffixSQL};
exportProperty(websql.ValueOperatorHandler,"Unary",websql.ValueOperatorHandler.Unary);websql.ValueOperatorHandler.Unary.prototype.appendExpansion=function(query,converter,leftOperandAppender,rightOperand){if(DEBUG&&!!rightOperand)throw new Error("Must not supply a right operand");if(this._prefixSQL)query.sql(this._prefixSQL);leftOperandAppender(query);if(this._suffixSQL)query.sql(this._suffixSQL)};exportProperty(websql.ValueOperatorHandler.Unary.prototype,"appendExpansion",websql.ValueOperatorHandler.Unary.prototype.appendExpansion);
websql.ValueOperatorHandler.Collection=function(operatorSQL){this._operatorSQL=operatorSQL};exportProperty(websql.ValueOperatorHandler,"Collection",websql.ValueOperatorHandler.Collection);
websql.ValueOperatorHandler.Collection.prototype.appendExpansion=function(query,converter,leftOperandAppender,rightOperand){if(DEBUG&&!rightOperand)throw new Error("Must supply a right operand");leftOperandAppender(query);query.sql(this._operatorSQL);query.expansion(function(parameters){var rightOperandAppender=rightOperand.appender;var value=parameters[rightOperand.parameterName];var builder=new websql.query.QueryBuilder;builder.groupStart("(");if(!value||!Array.isArray(value))rightOperandAppender(builder);
else{if(value.length<=0)throw new Error("Empty array parameter '"+rightOperand.parameterName+"'");for(var elementIndex=0;elementIndex<value.length;elementIndex++){rightOperandAppender(builder,elementIndex);builder.separator(",")}}builder.groupEnd(")");return builder.build()})};exportProperty(websql.ValueOperatorHandler.Collection.prototype,"appendExpansion",websql.ValueOperatorHandler.Collection.prototype.appendExpansion);
websql.ValueOperatorHandler.Binary=function(prefixSQL,operatorSQL,suffixSQL,comparison){this._prefixSQL=prefixSQL;this._operatorSQL=operatorSQL;this._suffixSQL=suffixSQL;this._comparison=comparison||false};exportProperty(websql.ValueOperatorHandler,"Binary",websql.ValueOperatorHandler.Binary);
websql.ValueOperatorHandler.Binary.prototype.appendExpansion=function(query,converter,leftOperandAppender,rightOperand){var $jscomp$this=this;if(DEBUG&&!rightOperand)throw new Error("Must supply a right operand");leftOperandAppender=this._prepareLeftOperandAppender(leftOperandAppender,converter);var rightOperandAppender=this._prepareRightOperandAppender(rightOperand.appender,converter);var internvalOperator=rightOperand.internalOperator||xdata.CollectionOperator.ANY;var internalInfix=websql.ValueOperatorHandler.Binary._INTERNAL_OPERATOR_INFIXES[internvalOperator];
if(!internalInfix)throw new Error("Invalid internal operator '"+internvalOperator+"'");query.expansion(function(parameters){var value=parameters[rightOperand.parameterName];var builder=new websql.query.QueryBuilder;if(!value||!Array.isArray(value)){if($jscomp$this._prefixSQL)builder.sql($jscomp$this._prefixSQL);leftOperandAppender(builder);builder.sql($jscomp$this._operatorSQL);rightOperandAppender(builder);if($jscomp$this._suffixSQL)builder.sql($jscomp$this._suffixSQL)}else{builder.groupStart("(");
if(value.length<=0)throw new Error("Empty array parameter '"+rightOperand.parameterName+"'");for(var elementIndex=0;elementIndex<value.length;elementIndex++){if($jscomp$this._prefixSQL)builder.sql($jscomp$this._prefixSQL);leftOperandAppender(builder);builder.sql($jscomp$this._operatorSQL);rightOperandAppender(builder,elementIndex);if($jscomp$this._suffixSQL)builder.sql($jscomp$this._suffixSQL);builder.separator(internalInfix)}builder.groupEnd(")")}return builder.build()})};
exportProperty(websql.ValueOperatorHandler.Binary.prototype,"appendExpansion",websql.ValueOperatorHandler.Binary.prototype.appendExpansion);websql.ValueOperatorHandler.Binary.prototype._prepareLeftOperandAppender=function(appender,converter){if(this._comparison){var nonComparableAppender=appender;appender=function(builder){converter.appendComparableTermExpansion(builder,nonComparableAppender)}}return appender};
websql.ValueOperatorHandler.Binary.prototype._prepareRightOperandAppender=function(appender,converter){if(this._comparison){var nonComparableAppender=appender;appender=(function(builder,index){converter.appendComparableTermExpansion(builder,function(builder){nonComparableAppender(builder,index)})})}return appender};websql.ValueOperatorHandler.Binary._INTERNAL_OPERATOR_INFIXES=function(){var map={};map[xdata.CollectionOperator.ALL]=") AND (";map[xdata.CollectionOperator.ANY]=") OR (";return map}();
websql.ValueOperatorHandler.OptimizedBinary=function(operatorSQL,allCollectionOperatorSQL,anyCollectionOperatorSQL){this._scalarHandler=new websql.ValueOperatorHandler.Binary(null,operatorSQL,null);this._collectionHandlers={};if(allCollectionOperatorSQL)this._collectionHandlers[xdata.CollectionOperator.ALL]=new websql.ValueOperatorHandler.Collection(allCollectionOperatorSQL);if(anyCollectionOperatorSQL)this._collectionHandlers[xdata.CollectionOperator.ANY]=new websql.ValueOperatorHandler.Collection(anyCollectionOperatorSQL)};
exportProperty(websql.ValueOperatorHandler,"OptimizedBinary",websql.ValueOperatorHandler.OptimizedBinary);
websql.ValueOperatorHandler.OptimizedBinary.prototype.appendExpansion=function(query,converter,leftOperandAppender,rightOperand){var internvalOperator=rightOperand.internalOperator||xdata.CollectionOperator.ANY;var collectionHandler=this._collectionHandlers[internvalOperator];if(collectionHandler)return collectionHandler.appendExpansion(query,converter,leftOperandAppender,rightOperand);return this._scalarHandler.appendExpansion(query,converter,leftOperandAppender,rightOperand)};
exportProperty(websql.ValueOperatorHandler.OptimizedBinary.prototype,"appendExpansion",websql.ValueOperatorHandler.OptimizedBinary.prototype.appendExpansion);websql.OperatorHandlers={};websql.OperatorHandlers.LOGIC=function(){var LogicOperator=xdata.LogicOperator;var map={};map[LogicOperator.NOT]=new websql.LogicOperatorHandler.Unary("NOT");map[LogicOperator.AND]=new websql.LogicOperatorHandler.Binary("AND");map[LogicOperator.OR]=new websql.LogicOperatorHandler.Binary("OR");return map}();exportSymbol("websql.OperatorHandlers.LOGIC",websql.OperatorHandlers.LOGIC);
websql.OperatorHandlers.VALUE=function(){var ValueOperator=xdata.ValueOperator;var UnaryHandler=websql.ValueOperatorHandler.Unary;var CollectionHandler=websql.ValueOperatorHandler.Collection;var BinaryHandler=websql.ValueOperatorHandler.Binary;var OptimizedBinaryHandler=websql.ValueOperatorHandler.OptimizedBinary;var map={};var GLOB_ESC_BEG="REPLACE(REPLACE(";var GLOB_ESC_END=",'*','[*]'),'?','[?]')";map[ValueOperator.EMPTY]=new UnaryHandler(null,"\x3d ''");map[ValueOperator.NOT_EMPTY]=new UnaryHandler(null,
"\x3c\x3e ''");map[ValueOperator.NULL]=new UnaryHandler(null,"IS NULL");map[ValueOperator.NOT_NULL]=new UnaryHandler(null,"IS NOT NULL");map[ValueOperator.IN]=new CollectionHandler("IN");map[ValueOperator.NOT_IN]=new CollectionHandler("NOT IN");map[ValueOperator.EQUAL]=new OptimizedBinaryHandler("\x3d",null,"IN");map[ValueOperator.EQUAL_IGNORE_CASE]=new BinaryHandler("LOWER(",") \x3d LOWER(",")");map[ValueOperator.NOT_EQUAL]=new OptimizedBinaryHandler("\x3c\x3e","NOT IN",null);map[ValueOperator.NOT_EQUAL_IGNORE_CASE]=
new BinaryHandler("LOWER(",") \x3c\x3e LOWER(",")");map[ValueOperator.GREATER]=new BinaryHandler(null,"\x3e",null,true);map[ValueOperator.GREATER_OR_EQUAL]=new BinaryHandler(null,"\x3e\x3d",null,true);map[ValueOperator.LESSER]=new BinaryHandler(null,"\x3c",null,true);map[ValueOperator.LESSER_OR_EQUAL]=new BinaryHandler(null,"\x3c\x3d",null,true);map[ValueOperator.BEGINNING]=new BinaryHandler(null,"GLOB "+GLOB_ESC_BEG,GLOB_ESC_END+" || '*'");map[ValueOperator.BEGINNING_IGNORE_CASE]=new BinaryHandler("LOWER(",
") GLOB "+GLOB_ESC_BEG+"LOWER(",")"+GLOB_ESC_END+" || '*'");map[ValueOperator.NOT_BEGINNING]=new BinaryHandler(null,"NOT GLOB "+GLOB_ESC_BEG,GLOB_ESC_END+" || '*'");map[ValueOperator.NOT_BEGINNING_IGNORE_CASE]=new BinaryHandler("LOWER(",") NOT GLOB "+GLOB_ESC_BEG+"LOWER(",")"+GLOB_ESC_END+" || '*'");map[ValueOperator.CONTAINING]=new BinaryHandler(null,"GLOB '*' || "+GLOB_ESC_BEG,GLOB_ESC_END+" || '*'");map[ValueOperator.CONTAINING_IGNORE_CASE]=new BinaryHandler("LOWER(",") GLOB '*' || "+GLOB_ESC_BEG+
"LOWER(",")"+GLOB_ESC_END+" || '*'");map[ValueOperator.NOT_CONTAINING]=new BinaryHandler(null,"NOT GLOB '*' || "+GLOB_ESC_BEG,GLOB_ESC_END+" || '*'");map[ValueOperator.NOT_CONTAINING_IGNORE_CASE]=new BinaryHandler("LOWER(",") NOT GLOB '*' || "+GLOB_ESC_BEG+"LOWER(",")"+GLOB_ESC_END+" || '*'");map[ValueOperator.ENDING]=new BinaryHandler(null,"GLOB '*' || "+GLOB_ESC_BEG,GLOB_ESC_END+"");map[ValueOperator.ENDING_IGNORE_CASE]=new BinaryHandler("LOWER(",") GLOB '*' || "+GLOB_ESC_BEG+"LOWER(",")"+GLOB_ESC_END+
"");map[ValueOperator.NOT_ENDING]=new BinaryHandler(null,"NOT GLOB '*' || "+GLOB_ESC_BEG,GLOB_ESC_END+"");map[ValueOperator.NOT_ENDING_IGNORE_CASE]=new BinaryHandler("LOWER(",") NOT GLOB '*' || "+GLOB_ESC_BEG+"LOWER(",")"+GLOB_ESC_END+"");return map}();exportSymbol("websql.OperatorHandlers.VALUE",websql.OperatorHandlers.VALUE);websql.Provider=function(options){this._asyncOpen=options&&options.asyncOpen||false};exportSymbol("websql.Provider",websql.Provider);websql.Provider.prototype.createDatabase=function(version,schema){if(typeof GLOBAL.openDatabase!=="function")throw new Error("WebSQL is not supported by the current environment");var dbSchema=websql.schema.Schema.fromProviderSchema(schema);return new websql.Database(version,dbSchema,this._asyncOpen)};exportProperty(websql.Provider.prototype,"createDatabase",websql.Provider.prototype.createDatabase);
websql.Provider.prototype.hasFeature=function(feature){switch(feature){case xdata.ProviderFeature.ATOMIC_TRANSACTIONS:return true}return false};exportProperty(websql.Provider.prototype,"hasFeature",websql.Provider.prototype.hasFeature);xdata.registerProvider("websql",websql.Provider);websql.query.ROWID_COLUMN_NAME="_rowid_";exportSymbol("websql.query.ROWID_COLUMN_NAME",websql.query.ROWID_COLUMN_NAME);websql.query.ROWID_COLUMN_TYPE=xdata.SimpleType.INTEGER;exportSymbol("websql.query.ROWID_COLUMN_TYPE",websql.query.ROWID_COLUMN_TYPE);websql.schema={};websql.schema.Element=function(){this._sealed=false};websql.schema.Element.prototype.seal=function(){this._sealed=true};websql.schema.Element.prototype.ensureNotSealed=function(){if(this._sealed)throw new Error("The element cannot be modified");};exportProperty(websql.schema.Element.prototype,"ensureNotSealed",websql.schema.Element.prototype.ensureNotSealed);websql.schema.Relation=function(name,identities){websql.schema.Element.call(this);this.name=name;this.table1=null;this.table2=null;this.accessor=null;this.identities=websql.schema.normalizeIdentities(identities,name)};extendConstructor(websql.schema.Relation,websql.schema.Element);websql.schema.Relation.prototype.initTables=function(table1,table2){this.ensureNotSealed();if(this.table1||this.table2)throw new Error("Relation already assigned to a pair of tables");this.table1=table1;this.table2=table2};
websql.schema.Relation.prototype.initAccessor=function(accessor){this.ensureNotSealed();if(this.accessor)throw new Error("Relation already assigned an accessor");this.accessor=accessor};websql.schema.Relation.prototype.toString=function(){return this.name};websql.schema.Relation.fromRelationProviderSchema=function(source){var name=source.name;var identities=source.identities;return new websql.schema.Relation(name,identities)};websql.RelationAccessor=function(){};websql.RelationAccessor.prototype.hasSameStructure=function(accessor){};websql.RelationAccessor.prototype.getBaseTable=function(){};websql.RelationAccessor.prototype.getUniqueSide=function(){};websql.RelationAccessor.prototype.appendTupleSelection=function(query,uniqueSide){};websql.RelationAccessor.prototype.insertsByUpdating=function(){};websql.RelationAccessor.prototype.appendTupleInsertion=function(query,inputAppender){};
websql.RelationAccessor.prototype.appendTupleUpdating=function(query,inputAppender,inputTester){};websql.RelationAccessor.prototype.appendTupleDeletion=function(query){};websql.RelationAccessor.prototype.mayImportKeys=function(side){};websql.RelationAccessor.prototype.appendKeyImportJoin=function(query,side,sourceTable,sourceTableAlias,sourceCols){};websql.RelationAccessor.prototype.appendTableJoin=function(query,side,tableAlias){};
websql.RelationAccessor.prototype.getEquivalentColumn=function(side,column){};websql.RelationAccessor.prototype.getConnectionRelation=function(endName){};websql.RelationAccessor.Connection=function(baseTable,connectedTable){this._baseTable=baseTable;this._connectedTable=connectedTable};websql.RelationAccessor.Connection.prototype.hasSameStructure=UNSUPPORTED_METHOD;websql.RelationAccessor.Connection.prototype.getBaseTable=function(){return this._baseTable};
websql.RelationAccessor.Connection.prototype.getConnectedTable=function(){return this._connectedTable};websql.RelationAccessor.Connection.prototype.getUniqueSide=UNSUPPORTED_METHOD;websql.RelationAccessor.Connection.prototype.appendTupleSelection=UNSUPPORTED_METHOD;websql.RelationAccessor.Connection.prototype.insertsByUpdating=UNSUPPORTED_METHOD;websql.RelationAccessor.Connection.prototype.appendTupleInsertion=UNSUPPORTED_METHOD;websql.RelationAccessor.Connection.prototype.appendTupleUpdating=UNSUPPORTED_METHOD;
websql.RelationAccessor.Connection.prototype.appendTupleDeletion=UNSUPPORTED_METHOD;websql.RelationAccessor.Connection.prototype.mayImportKeys=UNSUPPORTED_METHOD;websql.RelationAccessor.Connection.prototype.appendKeyImportJoin=UNSUPPORTED_METHOD;websql.RelationAccessor.Connection.prototype.getEquivalentColumn=function(side,column){if(side!==websql.RelationSide.ONE)return null;return this.getConnectedEquivalentColumn(column)};
websql.RelationAccessor.Connection.prototype.getConnectedEquivalentColumn=ABSTRACT_METHOD;websql.RelationAccessor.Connection.prototype.appendTableJoin=function(query,side,tableAlias){if(side!==websql.RelationSide.ONE)throw new Error("Cannot join from side "+side);return this.appendConnectedTableJoin(query,tableAlias)};websql.RelationAccessor.Connection.prototype.appendConnectedTableJoin=ABSTRACT_METHOD;websql.RelationAccessor.Connection.prototype.getConnectionRelation=function(){return null};
websql.RelationAccessor.Bridged=function(bridgeTable,config1,config2){this._bridgeTable=bridgeTable;this._cols=[config1.bridgeCols.slice(),config2.bridgeCols.slice()];this._tables=[config1.table,config2.table];this._self=config1.table===config2.table;if(DEBUG){this._cols[0].forEach(websql.RelationAccessor._verifyColumnTable.bind(null,bridgeTable));this._cols[1].forEach(websql.RelationAccessor._verifyColumnTable.bind(null,bridgeTable))}this._connectionRels={};[config1,config2].forEach(function(config,
i){var accessor=new websql.RelationAccessor.BridgedConnection(this._bridgeTable,config.bridgeCols,config.table);var connectionRel=websql.RelationAccessor._createConnectionRelation(accessor);this._connectionRels[config.endName]=connectionRel;if(!this._self)this._connectionRels[config.table.name]=connectionRel},this)};websql.RelationAccessor.Bridged.prototype.hasSameStructure=function(accessor){return accessor instanceof websql.RelationAccessor.Bridged};
websql.RelationAccessor.Bridged.prototype.getBaseTable=function(){return this.getBridgeTable()};websql.RelationAccessor.Bridged.prototype.getBridgeTable=function(){return this._bridgeTable};websql.RelationAccessor.Bridged.prototype.getUniqueSide=function(){return null};websql.RelationAccessor.Bridged.prototype.appendTupleSelection=function(query,uniqueSide){var allCols=this._cols;return websql.RelationAccessor._appendTupleSelect(query,this._bridgeTable,allCols,uniqueSide)};
websql.RelationAccessor.Bridged.prototype.insertsByUpdating=function(){return false};
websql.RelationAccessor.Bridged.prototype.appendTupleInsertion=function(query,inputAppender){var allCols=this._cols[0].concat(this._cols[1]);query.sql("INSERT INTO");query.quotedName(this._bridgeTable.dbName,this._bridgeTable.name);query.groupStart("(");allCols.forEach(function(col){query.quotedName(col.name);query.separator(", ")});query.groupEnd(")");query.sql("VALUES");query.groupStart("(");allCols.forEach(function(col){inputAppender(query,col);query.separator(", ")});query.groupEnd(")")};
websql.RelationAccessor.Bridged.prototype.appendTupleUpdating=function(query,inputAppender,inputTester){var allCols=this._cols[0].concat(this._cols[1]);var oneSet=false;query.sql("UPDATE");query.quotedName(this._bridgeTable.dbName,this._bridgeTable.name);query.sql("SET");query.groupStart();allCols.forEach(function(col){if(!inputTester(col))return;oneSet=true;query.quotedName(col.name);query.sql("\x3d");inputAppender(query,col);query.separator(", ")});query.groupEnd();if(!oneSet)throw new Error("Must provide an input for at least one column");
};websql.RelationAccessor.Bridged.prototype.appendTupleDeletion=function(query){query.sql("DELETE FROM");query.quotedName(this._bridgeTable.dbName,this._bridgeTable.name)};websql.RelationAccessor.Bridged.prototype.mayImportKeys=function(side){return false};websql.RelationAccessor.Bridged.prototype.appendKeyImportJoin=function(query,side,sourceTable,sourceTableAlias,sourceCols){throw new Error("Not supported for bridged relations");};
websql.RelationAccessor.Bridged.prototype.appendTableJoin=function(query,side,tableAlias){var rightSide=websql.RelationSide.oppositeOf(side);var joinedTableAlias=query.createAlias("t");var leftTable=this._tables[side];var rightTable=this._tables[rightSide];var leftBridgeCols=this._cols[side];var rightBridgeCols=this._cols[rightSide];var bridgeTable=this._bridgeTable;var bridgeAlias=tableAlias+"_"+joinedTableAlias;websql.RelationAccessor._appendLeftOuterJoin(query,tableAlias,leftTable.keyColumns,bridgeTable,
bridgeAlias,leftBridgeCols);websql.RelationAccessor._appendLeftOuterJoin(query,bridgeAlias,rightBridgeCols,rightTable,joinedTableAlias,rightTable.keyColumns);return{table:rightTable,many:true,alias:joinedTableAlias}};websql.RelationAccessor.Bridged.prototype.getEquivalentColumn=function(side,column){return null};websql.RelationAccessor.Bridged.prototype.getConnectionRelation=function(endName){var rel=this._connectionRels[endName];if(rel)return{relation:rel,side:websql.RelationSide.ONE};return null};
websql.RelationAccessor.BridgedConnection=function(bridgeTable,bridgeCols,connectedTable){websql.RelationAccessor.Connection.call(this,bridgeTable,connectedTable);this._cols=bridgeCols.slice();if(DEBUG)this._cols.forEach(websql.RelationAccessor._verifyColumnTable.bind(null,bridgeTable))};extendConstructor(websql.RelationAccessor.BridgedConnection,websql.RelationAccessor.Connection);
websql.RelationAccessor.BridgedConnection.prototype.getConnectedEquivalentColumn=function(column){if(column.key&&column.table===this.getConnectedTable()){var keyColumnIndex=column.table.keyColumns.indexOf(column);return this._cols[keyColumnIndex]}return null};
websql.RelationAccessor.BridgedConnection.prototype.appendConnectedTableJoin=function(query,tableAlias){var joinedTableAlias=query.createAlias("t");var rightTable=this.getConnectedTable();websql.RelationAccessor._appendLeftOuterJoin(query,tableAlias,this._cols,rightTable,joinedTableAlias,rightTable.keyColumns);return{table:rightTable,many:false,alias:joinedTableAlias}};
websql.RelationAccessor.Collapsed=function(collapsedSide,collapsedConfig,otherConfig){this._collapsedSide=collapsedSide;this._collapsedTable=collapsedConfig.table;this._collapsedCols=collapsedConfig.columns;this._collapsedMany=collapsedConfig.many;this._otherTable=otherConfig.table;this._self=this._collapsedTable===this._otherTable;if(DEBUG)this._collapsedCols.forEach(websql.RelationAccessor._verifyColumnTable.bind(null,collapsedConfig.table));this._connectionRels={};(function(){var accessor=new websql.RelationAccessor.CollapsedSelfConnection(this._collapsedTable);
var connectionRel=websql.RelationAccessor._createConnectionRelation(accessor);this._connectionRels[collapsedConfig.endName]=connectionRel;if(!this._self)this._connectionRels[this._collapsedTable.name]=connectionRel}).call(this);(function(){var accessor=new websql.RelationAccessor.CollapsedOtherConnection(this._collapsedTable,this._collapsedCols,this._otherTable);var connectionRel=websql.RelationAccessor._createConnectionRelation(accessor);this._connectionRels[otherConfig.endName]=connectionRel;if(!this._self)this._connectionRels[this._otherTable.name]=
connectionRel}).call(this)};websql.RelationAccessor.Collapsed.prototype.hasSameStructure=function(accessor){return accessor instanceof websql.RelationAccessor.Collapsed&&accessor._collapsedSide===this._collapsedSide};websql.RelationAccessor.Collapsed.prototype.getBaseTable=function(){return this.getCollapsedTable()};websql.RelationAccessor.Collapsed.prototype.getCollapsedTable=function(){return this._collapsedTable};websql.RelationAccessor.Collapsed.prototype.getCollapsedColumns=function(){return this._collapsedCols};
websql.RelationAccessor.Collapsed.prototype.getUniqueSide=function(){return this._collapsedSide};websql.RelationAccessor.Collapsed.prototype.appendTupleSelection=function(query,uniqueSide){var allCols;if(this._collapsedSide===websql.RelationSide.ONE)allCols=[this._collapsedTable.keyColumns,this._collapsedCols];else allCols=[this._collapsedCols,this._collapsedTable.keyColumns];return websql.RelationAccessor._appendTupleSelect(query,this._collapsedTable,allCols,uniqueSide)};
websql.RelationAccessor.Collapsed.prototype.insertsByUpdating=function(){return true};
websql.RelationAccessor.Collapsed.prototype.appendTupleInsertion=function(query,inputAppender){query.sql("UPDATE");query.quotedName(this._collapsedTable.dbName,this._collapsedTable.name);query.sql("SET");query.groupStart();this._collapsedCols.forEach(function(col){query.quotedName(col.name);query.sql("\x3d");inputAppender(query,col);query.separator(", ")});query.groupEnd();query.sql("WHERE");query.groupStart();this._collapsedTable.keyColumns.forEach(function(keyCol){query.quotedName(keyCol.name);query.sql("\x3d");
inputAppender(query,keyCol);query.separator(" AND ")});query.groupEnd()};websql.RelationAccessor.Collapsed.prototype.appendTupleUpdating=function(query,inputAppender){query.sql("UPDATE");query.quotedName(this._collapsedTable.dbName,this._collapsedTable.name);query.sql("SET");query.groupStart();this._collapsedCols.forEach(function(col){query.quotedName(col.name);query.sql("\x3d");inputAppender(query,col);query.separator(", ")});query.groupEnd()};
websql.RelationAccessor.Collapsed.prototype.appendTupleDeletion=function(query){query.sql("UPDATE");query.quotedName(this._collapsedTable.dbName,this._collapsedTable.name);query.sql("SET");query.groupStart();this._collapsedCols.forEach(function(col){query.quotedName(col.name);query.sql("\x3d NULL");query.separator(", ")});query.groupEnd()};websql.RelationAccessor.Collapsed.prototype.mayImportKeys=function(side){return side===this._collapsedSide};
websql.RelationAccessor.Collapsed.prototype.appendKeyImportJoin=function(query,side,sourceTable,sourceTableAlias,sourceCols){if(side!==this._collapsedSide)throw new Error("Not supported on the other side of collapsed relations");var keyCols=this._collapsedTable.keyColumns;if(DEBUG&&keyCols.length!==sourceCols.length)throw new Error("Must specify a source column for each key column");websql.RelationAccessor._appendLeftOuterJoin(query,"",keyCols,sourceTable,sourceTableAlias,sourceCols)};
websql.RelationAccessor.Collapsed.prototype.appendTableJoin=function(query,side,tableAlias){var joinedTableAlias=query.createAlias("t");var leftTable,rightTable,leftCols,rightCols;if(side===this._collapsedSide){leftTable=this._collapsedTable;rightTable=this._otherTable;leftCols=this._collapsedCols;rightCols=rightTable.keyColumns}else{leftTable=this._otherTable;rightTable=this._collapsedTable;leftCols=leftTable.keyColumns;rightCols=this._collapsedCols}websql.RelationAccessor._appendLeftOuterJoin(query,
tableAlias,leftCols,rightTable,joinedTableAlias,rightCols);return{table:rightTable,many:side!==this._collapsedSide&&this._collapsedMany,alias:joinedTableAlias}};websql.RelationAccessor.Collapsed.prototype.getEquivalentColumn=function(side,column){if(column.key&&column.table===this._otherTable){var keyColumnIndex=column.table.keyColumns.indexOf(column);return this._collapsedCols[keyColumnIndex]}return null};
websql.RelationAccessor.Collapsed.prototype.getConnectionRelation=function(endName){var rel=this._connectionRels[endName];if(rel)return{relation:rel,side:websql.RelationSide.ONE};return null};websql.RelationAccessor.CollapsedOtherConnection=function(collapsedTable,collapsedCols,otherTable){websql.RelationAccessor.Connection.call(this,collapsedTable,otherTable);this._collapsedCols=collapsedCols;if(DEBUG)this._collapsedCols.forEach(websql.RelationAccessor._verifyColumnTable.bind(null,collapsedTable))};
extendConstructor(websql.RelationAccessor.CollapsedOtherConnection,websql.RelationAccessor.Connection);websql.RelationAccessor.CollapsedOtherConnection.prototype.getConnectedEquivalentColumn=function(column){if(column.key&&column.table===this.getConnectedTable()){var keyColumnIndex=column.table.keyColumns.indexOf(column);return this._collapsedCols[keyColumnIndex]}return null};
websql.RelationAccessor.CollapsedOtherConnection.prototype.appendConnectedTableJoin=function(query,tableAlias){var joinedTableAlias=query.createAlias("t");var rightTable=this.getConnectedTable();var baseCols=this._collapsedCols;websql.RelationAccessor._appendLeftOuterJoin(query,tableAlias,baseCols,rightTable,joinedTableAlias,rightTable.keyColumns);return{table:rightTable,many:false,alias:joinedTableAlias}};
websql.RelationAccessor.CollapsedSelfConnection=function(collapsedTable){websql.RelationAccessor.Connection.call(this,collapsedTable,collapsedTable)};extendConstructor(websql.RelationAccessor.CollapsedSelfConnection,websql.RelationAccessor.Connection);websql.RelationAccessor.CollapsedSelfConnection.prototype.getConnectedEquivalentColumn=function(column){if(column.table===this.getBaseTable())return column;return null};
websql.RelationAccessor.CollapsedSelfConnection.prototype.appendConnectedTableJoin=function(query,tableAlias){return{table:this.getBaseTable(),many:false,alias:tableAlias}};websql.RelationAccessor._verifyColumnTable=function(expectedTable,column){if(expectedTable!==column.table)throw new Error("Column "+column.name+" is not from table "+expectedTable.name);};
websql.RelationAccessor._appendTupleSelect=function(query,table,allCols,uniqueSideIndex){var allAliases=[];query.sql("SELECT").groupStart();allCols.forEach(function(sideCols,i){var sideAliases=[];sideCols.forEach(function(col,j){var alias="side"+i+"_"+j;sideAliases.push(alias);query.quotedName(col.name).sql("AS").quotedName(alias).separator(", ")});allAliases.push(sideAliases)});query.groupEnd();query.sql("FROM").quotedName(table.dbName,table.name);if(typeof uniqueSideIndex==="number"){query.sql("GROUP BY").groupStart();
allAliases[uniqueSideIndex].forEach(function(alias){query.quotedName(alias).separator(", ")});query.groupEnd();query.sql("HAVING COUNT(*) \x3d 1")}return{aliases:allAliases}};
websql.RelationAccessor._appendLeftOuterJoin=function(query,leftTableAlias,leftCols,rightTable,rightTableAlias,rightCols){query.sql("LEFT OUTER JOIN");query.quotedName(rightTable.dbName,rightTable.name).sql("AS").quotedName(rightTableAlias);query.sql("ON").groupStart();leftCols.forEach(function(leftCol,i){query.quotedName(leftTableAlias,leftCol.name);query.sql("\x3d");query.quotedName(rightTableAlias,rightCols[i].name);query.separator(" AND ")});query.groupEnd()};
websql.RelationAccessor._createConnectionRelation=function(accessor){var rel=new websql.schema.Relation("_connection",[]);rel.initTables(accessor.getBaseTable(),accessor.getConnectedTable());rel.initAccessor(accessor);return rel};websql.TrackingWriteCommand=function(db,queryTemplate,beforePassthroughs,beforeCommand,afterPassthroughs,afterCommand){websql.WriteCommand.call(this);if(DEBUG&&(beforePassthroughs&&!beforeCommand))throw new Error("A before command is required for before passthrough");this._queryTemplate=queryTemplate;this._beforeFiller=null;if(beforeCommand)this._beforeFiller=websql.TrackingWriteCommand._createTrackedObjectsFillter(beforePassthroughs);this._beforeCommand=beforeCommand;this._afterFiller=null;if(afterCommand||
afterPassthroughs&&afterPassthroughs.length>0)this._afterFiller=websql.TrackingWriteCommand._createTrackedObjectsFillter(afterPassthroughs);this._afterCommand=afterCommand;this._maxStatementInputs=db.getSchema().maxStatementInputs};extendConstructor(websql.TrackingWriteCommand,websql.WriteCommand);exportSymbol("websql.TrackingWriteCommand",websql.TrackingWriteCommand);websql.TrackingWriteCommand.ROWID_PROPERTY_NAME="_rowid";exportProperty(websql.TrackingWriteCommand,"ROWID_PROPERTY_NAME",websql.TrackingWriteCommand.ROWID_PROPERTY_NAME);
websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER="rowid";exportProperty(websql.TrackingWriteCommand,"ROWID_VALUE_PARAMETER",websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER);
websql.TrackingWriteCommand.prototype.execute=function(tx,parameters,callback,errorCallback){var $jscomp$this=this;var rowids=[];var trackedObjects=({});this._executeTrackingBefore(tx,parameters,rowids,trackedObjects,function(){if($jscomp$this._beforeCommand&&rowids.length<=0)return callback([]);var expectInsertId=!$jscomp$this._beforeCommand;$jscomp$this._executeMainOperation(tx,parameters,rowids,expectInsertId,function(result){if(result.rowsAffected<=0)return callback([]);if(expectInsertId)rowids.push(result.insertId);
$jscomp$this._executeTrackingAfter(tx,parameters,rowids,trackedObjects,function(){if(DEBUG&&result.rowsAffected!==rowids.length)throw new Error("Unexpected number of tracked objects");callback(rowids.map(function(rowid){return trackedObjects[rowid]}))},errorCallback)},errorCallback)},errorCallback)};exportProperty(websql.TrackingWriteCommand.prototype,"execute",websql.TrackingWriteCommand.prototype.execute);
websql.TrackingWriteCommand.prototype._executeTrackingBefore=function(tx,parameters,rowids,trackedObjects,callback,errorCallback){var ROWID_PROPERTY_NAME=websql.TrackingWriteCommand.ROWID_PROPERTY_NAME;var filler=this._beforeFiller;if(!filler){callback();return}this._beforeCommand.executeScan(tx,parameters,function(values){var rowid=values[ROWID_PROPERTY_NAME];delete values[ROWID_PROPERTY_NAME];rowids.push(rowid);filler(trackedObjects,rowid,values,parameters)},callback,errorCallback)};
websql.TrackingWriteCommand.prototype._executeTrackingAfter=function(tx,parameters,rowids,trackedObjects,callback,errorCallback){var ROWID_PROPERTY_NAME=websql.TrackingWriteCommand.ROWID_PROPERTY_NAME;var filler=this._afterFiller;if(!filler){callback();return}if(this._afterCommand)this._scanSelectCommand(this._afterCommand,tx,rowids,function(values){var rowid=values[ROWID_PROPERTY_NAME];delete values[ROWID_PROPERTY_NAME];filler(trackedObjects,rowid,values,parameters)},callback,errorCallback);else{rowids.forEach(function(rowid){filler(trackedObjects,
rowid,undefined,parameters)});callback()}};
websql.TrackingWriteCommand.prototype._scanSelectCommand=function(selectCommand,tx,rowids,scanCallback,callback,errorCallback){var ROWID_VALUE_PARAMETER=websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER;var commandParameters={};commandParameters[ROWID_VALUE_PARAMETER]=rowids;var commandInputsCount=selectCommand.computeExpectedInputCount(commandParameters);if(commandInputsCount<=this._maxStatementInputs)selectCommand.executeScan(tx,commandParameters,scanCallback,callback,errorCallback);else{var chunkSize=
this._maxStatementInputs-(commandInputsCount-rowids.length);if(chunkSize<1){errorCallback(new Error("Too many parameters for tracking command execution"));return}this._scanSelectCommandOnChunks(selectCommand,tx,rowids,0,chunkSize,scanCallback,callback,errorCallback)}};
websql.TrackingWriteCommand.prototype._scanSelectCommandOnChunks=function(selectCommand,tx,rowids,chunkStart,chunkSize,scanCallback,callback,errorCallback){var $jscomp$this=this;var ROWID_VALUE_PARAMETER=websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER;var rowidsChunk=rowids.slice(chunkStart,chunkStart+chunkSize);var commandParameters={};commandParameters[ROWID_VALUE_PARAMETER]=rowidsChunk;selectCommand.executeScan(tx,commandParameters,scanCallback,function(){if(chunkStart+chunkSize<rowids.length)$jscomp$this._scanSelectCommandOnChunks(selectCommand,
tx,rowids,chunkStart+chunkSize,chunkSize,scanCallback,callback,errorCallback);else callback()},errorCallback)};websql.TrackingWriteCommand._Filler;
websql.TrackingWriteCommand._createTrackedObjectsFillter=function(passthroughs){var parametersPassthroughs=[];var rowidPropertyNames=[];if(passthroughs)passthroughs.forEach(function(pt){if(pt.valueParameter)parametersPassthroughs.push(pt);else rowidPropertyNames.push(pt.propertyName)});var filler=function filler(map,rowid,values,parameters){var trackedObject=map[rowid];if(!trackedObject)map[rowid]=trackedObject={};for(var i=0;i<parametersPassthroughs.length;i++){var pt=parametersPassthroughs[i];trackedObject[pt.propertyName]=
parameters[pt.valueParameter]}for(var i$0=0;i$0<rowidPropertyNames.length;i$0++)trackedObject[rowidPropertyNames[i$0]]=rowid;if(values)websql.util.assignObject(trackedObject,values)};return filler};
websql.TrackingWriteCommand.prototype._executeMainOperation=function(tx,parameters,rowids,expectInsertId,callback,errorCallback){var partialResults=[];var queryParameters=Object.create(parameters);queryParameters[websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER]=rowids;var fullQuery=this._queryTemplate.expand(queryParameters);if(fullQuery.inputData.length<=this._maxStatementInputs)this.executeQuery(tx,fullQuery,queryParameters,function(dbTx,result){partialResults.push(result);doAfterQueries()},websql.createErrorCallback(errorCallback));
else{var chunkSize=this._maxStatementInputs-(fullQuery.inputData.length-rowids.length);if(chunkSize<1){errorCallback(new Error("Too many parameters for tracking command execution"));return}this._executeMainQueryOnChunks(partialResults,tx,parameters,rowids,0,chunkSize,doAfterQueries,websql.createErrorCallback(errorCallback))}function doAfterQueries(){var insertId=expectInsertId?partialResults[0].insertId:undefined;var rowsAffected=0;for(var i=0;i<partialResults.length;i++)rowsAffected+=partialResults[i].rowsAffected;
callback({insertId:insertId,rowsAffected:rowsAffected})}};
websql.TrackingWriteCommand.prototype._executeMainQueryOnChunks=function(collectedResults,tx,parameters,rowids,chunkStart,chunkSize,callback,errorCallback){var $jscomp$this=this;var rowidsChunk=rowids.slice(chunkStart,chunkStart+chunkSize);var queryParameters=Object.create(parameters);queryParameters[websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER]=rowidsChunk;var query=this._queryTemplate.expand(queryParameters);this.executeQuery(tx,query,queryParameters,function(dbTx,result){collectedResults.push(result);
if(chunkStart+chunkSize<rowids.length)$jscomp$this._executeMainQueryOnChunks(collectedResults,tx,parameters,rowids,chunkStart+chunkSize,chunkSize,callback,errorCallback);else callback()},errorCallback)};websql.TrackingWriteCommand.prototype.computeExpectedInputCount=function(parameters){throw new Error("Unable to compute expect input count");};exportProperty(websql.TrackingWriteCommand.prototype,"computeExpectedInputCount",websql.TrackingWriteCommand.prototype.computeExpectedInputCount);websql.SelectCommandBuilder=function(db,storeOrRelationName,options){websql.CommandBuilder.call(this,db,storeOrRelationName,options)};extendConstructor(websql.SelectCommandBuilder,websql.CommandBuilder);websql.SelectCommandBuilder.prototype.build=ABSTRACT_METHOD;websql.WriteCommandBuilder=function(db,storeOrRelationName,options){websql.CommandBuilder.call(this,db,storeOrRelationName,options);this._hiddenSideEffects=db.getSchema().triggersExpected;this._filters=null;this._beforeFields=new websql.WriteCommandBuilder._TrackedFields("before the command");this._afterFields=new websql.WriteCommandBuilder._TrackedFields("after the command")};extendConstructor(websql.WriteCommandBuilder,websql.CommandBuilder);
websql.WriteCommandBuilder.prototype.includeBeforeTrackedField=function(fieldPath,propertyName){this._beforeFields.add(fieldPath,propertyName);if(this.isRowidAliasField(fieldPath))this._beforeFields.addExpectedFromRowid(fieldPath)};websql.WriteCommandBuilder.prototype.includeAfterTrackedField=function(fieldPath,propertyName){this._afterFields.add(fieldPath,propertyName);if(this.isRowidAliasField(fieldPath))this._afterFields.addExpectedFromRowid(fieldPath)};
websql.WriteCommandBuilder.prototype.includeAfterExpectedField=function(fieldPath,valueParameter){if(!this._hiddenSideEffects)this._afterFields.addExpectedFromParameters(fieldPath,valueParameter)};websql.WriteCommandBuilder.prototype.includeFilter=function(expr){websql.WriteCommandBuilder._super.includeFilter.call(this,expr);if(!this._filters)this._filters=[];this._filters.push(expr)};websql.WriteCommandBuilder.prototype.hasTrackedFields=function(){return!this._beforeFields.isEmpty()||!this._afterFields.isEmpty()};
websql.WriteCommandBuilder.prototype.buildBeforeTrackingPassthroughs=function(){return this._beforeFields.getPassthrough()};
websql.WriteCommandBuilder.prototype.buildBeforeTrackingCommand=function(builderCtor,rowidPropertyName){var fields=this._beforeFields.getRequired();var builder=this.createRelatedBuilder(builderCtor);builder.includeOutputRowid(rowidPropertyName);fields.forEach(function(field){builder.includeOutputField(field.fieldPath,field.propertyName)});if(this._filters)this._filters.forEach(function(filter){return builder.includeFilter(filter)});return builder.build()};
websql.WriteCommandBuilder.prototype.buildAfterTrackingPassthroughs=function(){return this._afterFields.getPassthrough()};
websql.WriteCommandBuilder.prototype.buildAfterTrackingCommand=function(builderCtor,rowidPropertyName,rowidValueParameter){var fields=this._afterFields.getRequired();if(fields.length<=0)return null;var builder=this.createRelatedBuilder(builderCtor);builder.includeOutputRowid(rowidPropertyName);fields.forEach(function(field){builder.includeOutputField(field.fieldPath,field.propertyName)});builder.includeFilterOnRowid(rowidValueParameter);return builder.build()};
websql.WriteCommandBuilder.prototype.build=function(){if(this.hasTrackedFields())return this.buildTracking();return this.buildNormal()};websql.WriteCommandBuilder.prototype.buildNormal=ABSTRACT_METHOD;websql.WriteCommandBuilder.prototype.buildTracking=ABSTRACT_METHOD;websql.WriteCommandBuilder._TrackedFields=function(purposeLabel){this._purposeLabel=purposeLabel;this._added;this._propertyNames=null;this._expectedValueParameters=null};websql.WriteCommandBuilder._TrackedFields.prototype.isEmpty=function(){return!this._added};
websql.WriteCommandBuilder._TrackedFields.prototype.add=function(fieldPath,propertyName){if(this._propertyNames&&this._propertyNames[fieldPath])throw new Error("Field path '"+fieldPath+"' is already added for tracking "+this._purposeLabel);(this._propertyNames||(this._propertyNames={}))[fieldPath]=propertyName;this._added=true};
websql.WriteCommandBuilder._TrackedFields.prototype.addExpectedFromRowid=function(fieldPath){if(this._expectedValueParameters&&this._expectedValueParameters[fieldPath])return;(this._expectedValueParameters||(this._expectedValueParameters={}))[fieldPath]=null};
websql.WriteCommandBuilder._TrackedFields.prototype.addExpectedFromParameters=function(fieldPath,valueParameter){if(this._expectedValueParameters&&this._expectedValueParameters[fieldPath])throw new Error("Field path '"+fieldPath+"' has already an expected value for tracking "+this._purposeLabel);(this._expectedValueParameters||(this._expectedValueParameters={}))[fieldPath]=valueParameter};
websql.WriteCommandBuilder._TrackedFields.prototype.getRequired=function(){var $jscomp$this=this;if(!this._propertyNames)return[];var result=[];Object.keys(this._propertyNames).forEach(function(fieldPath){if(!$jscomp$this._expectedValueParameters||$jscomp$this._expectedValueParameters[fieldPath]===undefined)result.push({fieldPath:fieldPath,propertyName:$jscomp$this._propertyNames[fieldPath]})});return result};
websql.WriteCommandBuilder._TrackedFields.prototype.getPassthrough=function(){var $jscomp$this=this;if(!this._propertyNames||!this._expectedValueParameters)return[];var result=[];Object.keys(this._propertyNames).forEach(function(fieldPath){var expectedValueParameter=$jscomp$this._expectedValueParameters[fieldPath];if(expectedValueParameter!==undefined)result.push({valueParameter:expectedValueParameter,propertyName:$jscomp$this._propertyNames[fieldPath]})});return result};websql.RelationDeleteCommandBuilder=function(db,relationName){websql.WriteCommandBuilder.call(this,db,relationName,{flatVariants:true})};extendConstructor(websql.RelationDeleteCommandBuilder,websql.WriteCommandBuilder);exportSymbol("websql.RelationDeleteCommandBuilder",websql.RelationDeleteCommandBuilder);websql.RelationDeleteCommandBuilder.prototype.addFilter=function(expr){this.includeFilter(expr)};exportProperty(websql.RelationDeleteCommandBuilder.prototype,"addFilter",websql.RelationDeleteCommandBuilder.prototype.addFilter);
websql.RelationDeleteCommandBuilder.prototype.addOutputField=function(fieldPath,propertyName){this.includeBeforeTrackedField(fieldPath,propertyName)};exportProperty(websql.RelationDeleteCommandBuilder.prototype,"addOutputField",websql.RelationDeleteCommandBuilder.prototype.addOutputField);
websql.RelationDeleteCommandBuilder.prototype.buildNormal=function(){var b=new websql.query.QueryTemplateBuilder;b.sql(this.buildRelationTupleDeletionQueryProlog());if(this.isWhereExpressionAvailable()){b.sql("WHERE");if(this.isFlatQueriesOnly())b.expansion(this.buildWhereExpression());else{b.sql(websql.query.ROWID_COLUMN_NAME).sql("IN").groupStart("(");b.expansion(this.buildWhereSubQuery());b.groupEnd(")")}}var queryTemplate=b.build();return new websql.NormalWriteCommand(queryTemplate)};
exportProperty(websql.RelationDeleteCommandBuilder.prototype,"buildNormal",websql.RelationDeleteCommandBuilder.prototype.buildNormal);
websql.RelationDeleteCommandBuilder.prototype.buildTracking=function(){var beforePass=this.buildBeforeTrackingPassthroughs();var beforeCmd=this.buildBeforeTrackingCommand(websql.RelationSelectCommandBuilder,websql.TrackingWriteCommand.ROWID_PROPERTY_NAME);var b=new websql.query.QueryTemplateBuilder;b.sql(this.buildRelationTupleDeletionQueryProlog());b.sql("WHERE");b.expansion(this.buildFlatWhereOnRowid(websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER));var queryTemplate=b.build();return new websql.TrackingWriteCommand(this.db,
queryTemplate,beforePass,beforeCmd,null,null)};exportProperty(websql.RelationDeleteCommandBuilder.prototype,"buildTracking",websql.RelationDeleteCommandBuilder.prototype.buildTracking);websql.RelationInsertCommandBuilder=function(db,relationName){websql.WriteCommandBuilder.call(this,db,relationName,{forbidJoins:true})};extendConstructor(websql.RelationInsertCommandBuilder,websql.WriteCommandBuilder);exportSymbol("websql.RelationInsertCommandBuilder",websql.RelationInsertCommandBuilder);websql.RelationInsertCommandBuilder.prototype.addInputField=function(fieldPath,valueParameter){this.includeInputField(fieldPath,valueParameter);this.includeAfterExpectedField(fieldPath,valueParameter)};
exportProperty(websql.RelationInsertCommandBuilder.prototype,"addInputField",websql.RelationInsertCommandBuilder.prototype.addInputField);websql.RelationInsertCommandBuilder.prototype.addOutputField=function(fieldPath,propertyName){this.includeAfterTrackedField(fieldPath,propertyName)};exportProperty(websql.RelationInsertCommandBuilder.prototype,"addOutputField",websql.RelationInsertCommandBuilder.prototype.addOutputField);
websql.RelationInsertCommandBuilder.prototype.buildNormal=function(){var queryTemplate=this.buildRelationTupleInsertionQuery();return new websql.NormalWriteCommand(queryTemplate)};exportProperty(websql.RelationInsertCommandBuilder.prototype,"buildNormal",websql.RelationInsertCommandBuilder.prototype.buildNormal);websql.RelationInsertCommandBuilder.prototype.buildTracking=function(){if(!this.isRelationInsertionByUpdate())return this._buildTrackingForInsert();return this._buildTrackingForUpdate()};
exportProperty(websql.RelationInsertCommandBuilder.prototype,"buildTracking",websql.RelationInsertCommandBuilder.prototype.buildTracking);
websql.RelationInsertCommandBuilder.prototype._buildTrackingForInsert=function(){var afterPass=this.buildAfterTrackingPassthroughs();var afterCmd=this.buildAfterTrackingCommand(websql.TableSelectCommandBuilder,websql.TrackingWriteCommand.ROWID_PROPERTY_NAME,websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER);var queryTemplate=this.buildRelationTupleInsertionQuery();return new websql.TrackingWriteCommand(this.db,queryTemplate,null,null,afterPass,afterCmd)};
websql.RelationInsertCommandBuilder.prototype._buildTrackingForUpdate=function(){var rowidAliasColumn=this.getRowidAliasColumn();if(!rowidAliasColumn)throw new Error("No rowid alias on relation base table");var rowidInputInfo=this.getInputColumn(rowidAliasColumn);if(!rowidInputInfo)throw new Error("Must provide an input for rowid column");var beforeCmd=new websql.RelationInsertCommandBuilder._BeforeUpdateCmd(rowidInputInfo);var afterPass=this.buildAfterTrackingPassthroughs();var afterCmd=this.buildAfterTrackingCommand(websql.TableSelectCommandBuilder,
websql.TrackingWriteCommand.ROWID_PROPERTY_NAME,websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER);var queryTemplate=this.buildRelationTupleInsertionQuery();return new websql.TrackingWriteCommand(this.db,queryTemplate,null,beforeCmd,afterPass,afterCmd)};websql.RelationInsertCommandBuilder._BeforeUpdateCmd=function(rowidInputInfo){websql.SelectCommand.call(this);this._rowidParameterName=rowidInputInfo.parameterName};extendConstructor(websql.RelationInsertCommandBuilder._BeforeUpdateCmd,websql.SelectCommand);
websql.RelationInsertCommandBuilder._BeforeUpdateCmd.prototype.executeScan=function(tx,parameters,scanCallback,callback,errorCallback){var object={};object[websql.TrackingWriteCommand.ROWID_PROPERTY_NAME]=parameters[this._rowidParameterName];scanCallback(object);callback()};websql.SelectionHelper=function(commandBuilder){this._commandBuilder=commandBuilder;this._extraResultColumns;this._extraOrderTerms;this._distinctAliases;this.refresh()};
websql.SelectionHelper.prototype.refresh=function(){var builder=this._commandBuilder;if(!builder.isJoined()||!builder.isJoinedToMany()){this._extraResultColumns=[];this._extraOrderTerms=[];this._distinctAliases=null;return}var joinedToManyNonResult=false;var keyColumnInfos=[];builder.getDataSets().forEach(function(dataSet){if(!(dataSet.element instanceof websql.schema.Table))return;var table=dataSet.element;if(!dataSet.usedInResults){if(dataSet.many)joinedToManyNonResult=true;return}table.keyColumns.forEach(function(keyColumn){keyColumnInfos.push({dataSet:dataSet,
column:keyColumn})})});this._extraOrderTerms=[];keyColumnInfos.forEach(function(info){if(!builder.hasOrderColumn(info.column))this._extraOrderTerms.push({dataSet:info.dataSet,column:info.column,descending:false})},this);this._extraResultColumns=[];if(joinedToManyNonResult){this._distinctAliases=[];var keyAliasCount=0;keyColumnInfos.forEach(function(info){var alias;var resultColumn=builder.getResultColumn(info.column);if(resultColumn)alias=resultColumn.alias;else{alias="key"+keyAliasCount++;this._extraResultColumns.push({dataSet:info.dataSet,
column:info.column,alias:alias})}this._distinctAliases.push(alias)},this)}else this._distinctAliases=null};websql.SelectionHelper.prototype.getExtraResultColumns=function(){return this._extraResultColumns};websql.SelectionHelper.prototype.getExtraOrderTerms=function(){return this._extraOrderTerms};websql.SelectionHelper.prototype.createAssemblerFactory=function(objectPropertyInfos){return new websql.SelectionHelper.AssemblerFactory(this._distinctAliases,objectPropertyInfos)};
websql.SelectionHelper.AssemblerFactory=function(distinctAliases,objectPropertyInfos){this._distinctAliases=distinctAliases;this._objectPropertyInfos=objectPropertyInfos};
websql.SelectionHelper.AssemblerFactory.prototype.createAssembler=function(){var $jscomp$this=this;var lastDistinctKey=null;var assembleFromRow=function(row){var distinctKey=$jscomp$this._computeDistinctKey(row);if(distinctKey!==null&&distinctKey===lastDistinctKey)return null;lastDistinctKey=distinctKey;return $jscomp$this._buildObject(row)};return assembleFromRow};
websql.SelectionHelper.AssemblerFactory.prototype._computeDistinctKey=function(row){var aliases=this._distinctAliases;if(!aliases)return null;var s="";for(var i=0;i<aliases.length;i++){if(i>0)s=s.concat("_$$_");s=s.concat(String(row[aliases[i]]))}return s};
websql.SelectionHelper.AssemblerFactory.prototype._buildObject=function(row){var propertyInfos=this._objectPropertyInfos;var object={};for(var i=0;i<propertyInfos.length;i++){var info=propertyInfos[i];var propertyValue=row[info.alias];object[info.propertyName]=info.converter.fromSQL(propertyValue)}return object};websql.RelationSelectCommandBuilder=function(db,relationName){websql.SelectCommandBuilder.call(this,db,relationName);this._distinct=false};extendConstructor(websql.RelationSelectCommandBuilder,websql.SelectCommandBuilder);exportSymbol("websql.RelationSelectCommandBuilder",websql.RelationSelectCommandBuilder);websql.RelationSelectCommandBuilder.prototype.useDistinct=function(){if(this._distinct)throw new Error("Distinct already set");this._distinct=true};
exportProperty(websql.RelationSelectCommandBuilder.prototype,"useDistinct",websql.RelationSelectCommandBuilder.prototype.useDistinct);websql.RelationSelectCommandBuilder.prototype.addOutputField=function(fieldPath,propertyName){this.includeOutputField(fieldPath,propertyName)};exportProperty(websql.RelationSelectCommandBuilder.prototype,"addOutputField",websql.RelationSelectCommandBuilder.prototype.addOutputField);websql.RelationSelectCommandBuilder.prototype.addFilter=function(expr){this.includeFilter(expr)};
exportProperty(websql.RelationSelectCommandBuilder.prototype,"addFilter",websql.RelationSelectCommandBuilder.prototype.addFilter);websql.RelationSelectCommandBuilder.prototype.addOrderTerm=function(term){this.includeOrderTerm(term)};exportProperty(websql.RelationSelectCommandBuilder.prototype,"addOrderTerm",websql.RelationSelectCommandBuilder.prototype.addOrderTerm);websql.RelationSelectCommandBuilder.prototype.addLimit=function(limit){this.includeLimit(limit)};
exportProperty(websql.RelationSelectCommandBuilder.prototype,"addLimit",websql.RelationSelectCommandBuilder.prototype.addLimit);
websql.RelationSelectCommandBuilder.prototype.build=function(){var helper=new websql.SelectionHelper(this);var extraResultColumns=helper.getExtraResultColumns();var extraOrderTerms=helper.getExtraOrderTerms();var b=new websql.query.QueryTemplateBuilder;b.sql(this._distinct?"SELECT DISTINCT":"SELECT");b.sql(this.buildResultList(extraResultColumns));b.sql("FROM").sql(this.buildFromExpression());if(this.isWhereExpressionAvailable())b.sql("WHERE").expansion(this.buildWhereExpression());if(this.isOrderExpressionAvailable()||
extraOrderTerms.length>0)b.sql("ORDER BY").sql(this.buildOrderExpression(extraOrderTerms));if(this.isLimitExpressionAvailable())b.sql("LIMIT").sql(this.buildLimitExpression());var queryTemplate=b.build();var assemblerFactory=helper.createAssemblerFactory(this.getResultColumns());return new websql.NormalSelectCommand(queryTemplate,assemblerFactory)};exportProperty(websql.RelationSelectCommandBuilder.prototype,"build",websql.RelationSelectCommandBuilder.prototype.build);websql.RelationSide={ONE:0,TWO:1};exportSymbol("websql.RelationSide",websql.RelationSide);websql.RelationSide.oppositeOf=function(side){return side===websql.RelationSide.ONE?websql.RelationSide.TWO:websql.RelationSide.ONE};exportProperty(websql.RelationSide,"oppositeOf",websql.RelationSide.oppositeOf);websql.RelationUpdateCommandBuilder=function(db,relationName){websql.WriteCommandBuilder.call(this,db,relationName,{flatVariants:true})};extendConstructor(websql.RelationUpdateCommandBuilder,websql.WriteCommandBuilder);exportSymbol("websql.RelationUpdateCommandBuilder",websql.RelationUpdateCommandBuilder);websql.RelationUpdateCommandBuilder.prototype.addInputField=function(fieldPath,valueParameter){this.includeInputField(fieldPath,valueParameter);this.includeAfterExpectedField(fieldPath,valueParameter)};
exportProperty(websql.RelationUpdateCommandBuilder.prototype,"addInputField",websql.RelationUpdateCommandBuilder.prototype.addInputField);websql.RelationUpdateCommandBuilder.prototype.addFilter=function(expr){this.includeFilter(expr)};exportProperty(websql.RelationUpdateCommandBuilder.prototype,"addFilter",websql.RelationUpdateCommandBuilder.prototype.addFilter);
websql.RelationUpdateCommandBuilder.prototype.addOutputField=function(fieldPath,before,propertyName){if(before)this.includeBeforeTrackedField(fieldPath,propertyName);else this.includeAfterTrackedField(fieldPath,propertyName)};exportProperty(websql.RelationUpdateCommandBuilder.prototype,"addOutputField",websql.RelationUpdateCommandBuilder.prototype.addOutputField);
websql.RelationUpdateCommandBuilder.prototype.buildNormal=function(){var b=new websql.query.QueryTemplateBuilder;b.fragment(this.buildRelationTupleUpdatingQueryProlog());if(this.isWhereExpressionAvailable()){b.sql("WHERE");if(this.isFlatQueriesOnly())b.expansion(this.buildWhereExpression());else{b.sql(websql.query.ROWID_COLUMN_NAME).sql("IN").groupStart("(");b.expansion(this.buildWhereSubQuery());b.groupEnd(")")}}var queryTemplate=b.build();return new websql.NormalWriteCommand(queryTemplate)};
exportProperty(websql.RelationUpdateCommandBuilder.prototype,"buildNormal",websql.RelationUpdateCommandBuilder.prototype.buildNormal);
websql.RelationUpdateCommandBuilder.prototype.buildTracking=function(){var beforePass=this.buildBeforeTrackingPassthroughs();var beforeCmd=this.buildBeforeTrackingCommand(websql.RelationSelectCommandBuilder,websql.TrackingWriteCommand.ROWID_PROPERTY_NAME);var afterPass=this.buildAfterTrackingPassthroughs();var afterCmd=this.buildAfterTrackingCommand(websql.RelationSelectCommandBuilder,websql.TrackingWriteCommand.ROWID_PROPERTY_NAME,websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER);var b=new websql.query.QueryTemplateBuilder;
b.fragment(this.buildRelationTupleUpdatingQueryProlog());b.sql("WHERE");b.expansion(this.buildFlatWhereOnRowid(websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER));var queryTemplate=b.build();return new websql.TrackingWriteCommand(this.db,queryTemplate,beforePass,beforeCmd,afterPass,afterCmd)};exportProperty(websql.RelationUpdateCommandBuilder.prototype,"buildTracking",websql.RelationUpdateCommandBuilder.prototype.buildTracking);websql.schema.Column=function(name,converter,key,identities){websql.schema.Element.call(this);websql.schema.Column._validateName(name);this.name=name;this.table=null;this.converter=converter;this.type=converter.sqlType;this.key=key;this.identities=websql.schema.normalizeIdentities(identities,name)};extendConstructor(websql.schema.Column,websql.schema.Element);
websql.schema.Column._validateName=function(name){if(name.toLowerCase()===websql.query.ROWID_COLUMN_NAME.toLowerCase())throw new Error("Column name '"+websql.query.ROWID_COLUMN_NAME+"' is reserved for internal use");};websql.schema.Column.prototype.initTable=function(table){this.ensureNotSealed();if(this.table)throw new Error("Column already assigned to a table");this.table=table};websql.schema.Column.prototype.toString=function(){return this.name};
websql.schema.Column.fromFieldProviderSchema=function(source){var name=source["properties"]["columnName"]||source.name;var converter=websql.Converters[xdata.util.castEnumValue(xdata.SimpleType,source.type)];var key=source.key;var identities=source.identities;return new websql.schema.Column(name,converter,key,identities)};websql.schema.Column.fromColumn=function(column,newName,newIdentities){return new websql.schema.Column(newName,column.converter,false,newIdentities)};websql.schema.ForeignKey=function(columns,referencedTable,referencedColumns){websql.schema.Element.call(this);websql.schema.ForeignKey._validate(columns,referencedTable,referencedColumns);this.columns=columns.slice();this.referencedTable=referencedTable;this.referencedColumns=referencedColumns.slice();this.identities=websql.schema.combineIdentities(":fk:/",websql.schema.mergeIdentities(columns.map(function(col){return col.identities})),referencedTable.identities,websql.schema.mergeIdentities(referencedColumns.map(function(referencedCol){return referencedCol.identities})))};
extendConstructor(websql.schema.ForeignKey,websql.schema.Element);
websql.schema.ForeignKey._validate=function(columns,referencedTable,referencedColumns){if(columns.length<=0)throw new Error("Foreign keys require at least one column");if(columns.length!==referencedColumns.length)throw new Error("The numbers of columns and referenced columns must match");var table=columns[0].table;if(!table)throw new Error("Some columns are not part of any table");columns.forEach(function(column){if(column.table!==table)throw new Error("All columns must be part of the same table");
});referencedColumns.forEach(function(column){if(column.table!==referencedTable)throw new Error("All referenced columns must be part of the referenced table");})};websql.schema.Index=function(name,unique,columns){websql.schema.Element.call(this);websql.schema.Index._validate(columns);this.name=name;this.unique=unique;this.table=columns[0].table;this.columns=columns.slice();this.identities=websql.schema.combineIdentities(":ix:/",websql.schema.mergeIdentities(columns.map(function(col){return col.identities})))};extendConstructor(websql.schema.Index,websql.schema.Element);
websql.schema.Index._validate=function(columns){if(columns.length<=0)throw new Error("Indexes require at least one column");var table=columns[0].table;if(!table)throw new Error("Some columns are not part of any table");columns.forEach(function(column){if(column.table!==table)throw new Error("All columns must be part of the same table");})};websql.schema.Index.prototype.toString=function(){return this.name};websql.schema.Table=function(name,dbName,identities){websql.schema.Element.call(this);this.name=name;this.dbName=dbName;this.identities=websql.schema.normalizeIdentities(identities,name);this.columns=[];this.keyColumns=[];this.columnsByName={};this.columnsByFieldName=[];this.rowidAliasColumn=null;this.attachedRelationsByEndName={};this.foreignKeys=[]};extendConstructor(websql.schema.Table,websql.schema.Element);
websql.schema.Table.prototype._defineSchemaForField=function(fieldSource){var column=websql.schema.Column.fromFieldProviderSchema(fieldSource);this.addColumn(column,fieldSource.name)};
websql.schema.Table.prototype.addColumn=function(column,fieldName){this.ensureNotSealed();column.initTable(this);this.columns.push(column);if(column.key)this.keyColumns.push(column);if(this.columnsByName[column.name])throw new Error("Column name '"+column.name+"' already in use");this.columnsByName[column.name]=column;if(fieldName){if(this.columnsByFieldName[fieldName])throw new Error("Column already defined for field '"+fieldName+"'");this.columnsByFieldName[fieldName]=column}var rowidAliasColumn;
if(this.keyColumns.length===1&&this.keyColumns[0].type==="INTEGER")this.rowidAliasColumn=this.keyColumns[0];else this.rowidAliasColumn=null};websql.schema.Table.prototype.addAttachedRelation=function(relation,side,endName){this.ensureNotSealed();if(this.attachedRelationsByEndName[endName])throw new Error("Relation end name '"+endName+"' already attached");this.attachedRelationsByEndName[endName]={relation:relation,side:side}};
websql.schema.Table.prototype.addForeignKey=function(foreignKey){this.ensureNotSealed();if(foreignKey.columns[0].table!==this)throw new Error("Foreign key is not based on this table");this.foreignKeys.push(foreignKey)};websql.schema.Table.prototype.seal=function(){this.columns.forEach(function(column){column.seal()});this.foreignKeys.forEach(function(foreignKey){foreignKey.seal()});websql.schema.Table._super.seal.call(this)};websql.schema.Table.prototype.toString=function(){return this.name};
websql.schema.Table.fromStoreProviderSchema=function(source){var name=source.properties["tableName"]||source["name"];var identities=source.identities;var table=new websql.schema.Table(name,"main",identities);source.fields.forEach(table._defineSchemaForField,table);return table};websql.schema.Schema=function(options){websql.schema.Element.call(this);this.tables=[];this.tablesByName={};this.tablesByStoreName={};this.relations=[];this.relationsByName={};this.indexes=[];this.indexesByName={};this._useForeignKeys=!!(options&&options.foreignKeys);this.triggersExpected=!!(options&&options.triggers);this.maxStatementInputs=options&&options.maxStatementInputs||950};extendConstructor(websql.schema.Schema,websql.schema.Element);
websql.schema.Schema.prototype._defineSchemaForStore=function(storeSource){var table=websql.schema.Table.fromStoreProviderSchema(storeSource);this.addTable(table,storeSource.name);storeSource.indexes.forEach(function(indexSource){this._defineSchemaForIndex(table,indexSource)},this)};
websql.schema.Schema.prototype.addTable=function(table,storeName){this.ensureNotSealed();this.tables.push(table);if(this.tablesByName[table.name])throw new Error("Table name '"+table.name+"' already in use");if(this.relationsByName[table.name])throw new Error("Table name '"+table.name+"' conflicts with a relation");this.tablesByName[table.name]=table;if(storeName){if(this.tablesByStoreName[storeName])throw new Error("Table already defined for store '"+storeName+"'");this.tablesByStoreName[storeName]=
table}};
websql.schema.Schema.prototype._defineSchemaForRelation=function(relationSource){var relationName=relationSource.name;var end1=relationSource.end1;var end2=relationSource.end2;var collapsedEnd=null;if(end1.properties["collapsedSide"])collapsedEnd=end1;if(end2.properties["collapsedSide"]){if(collapsedEnd)throw new Error("Relation '"+relationName+"' is collapsed on both sides");collapsedEnd=end2}var bridgeTableName=relationSource["properties"]["bridgeTableName"]||null;if(collapsedEnd&&bridgeTableName)throw new Error("Relation '"+relationName+
"' is collapsd while declaring a bridge table name");if(!bridgeTableName&&end1.many!==end2.many)collapsedEnd=end1.many?end1:end2;if(collapsedEnd)this._defineSchemaForCollapsedRelation(relationSource,collapsedEnd);else this._defineSchemaForBridgedRelation(relationSource,bridgeTableName||relationName)};
websql.schema.Schema.prototype._defineSchemaForBridgedRelation=function(relationSource,bridgeTableName){var end1=relationSource.end1;var end2=relationSource.end2;var table1=this._retrieveRelationEndTable(end1);var table2=this._retrieveRelationEndTable(end2);var relation=websql.schema.Relation.fromRelationProviderSchema(relationSource);var columnNames1=this._retrieveRelationEndColumnNames(end1,table1,"bridgeColumnName");var columnNames2=this._retrieveRelationEndColumnNames(end2,table2,"bridgeColumnName");
var bridgeInfo=this.createBridgeTable(bridgeTableName,"main",relation.identities,table1,table2,columnNames1,columnNames2);var bridgeTable=bridgeInfo.table;var fkCols1=bridgeInfo.fkCols1;var fkCols2=bridgeInfo.fkCols2;this.addTable(bridgeTable);relation.initTables(table1,table2);relation.initAccessor(new websql.RelationAccessor.Bridged(bridgeTable,{table:table1,bridgeCols:fkCols1,endName:end1.innerName},{table:table2,bridgeCols:fkCols2,endName:end2.innerName}));this.addRelation(relation);table1.addAttachedRelation(relation,
websql.RelationSide.ONE,end1.name);table2.addAttachedRelation(relation,websql.RelationSide.TWO,end2.name)};
websql.schema.Schema.prototype.createBridgeTable=function(name,dbName,relationIdentities,table1,table2,columnNames1,columnNames2){var tableIdentities=websql.schema.combineIdentities(":relbridge:",relationIdentities);var endIdentities1=websql.schema.combineIdentities(relationIdentities,"/1");var endIdentities2=websql.schema.combineIdentities(relationIdentities,"/2");var table=new websql.schema.Table(name,dbName,tableIdentities);var selfRelation=table1===table2;function computeBaseName(s,disambiguationSuffix){var baseName=
s.charAt(0).toLowerCase()+s.substring(1);if(selfRelation)baseName+=disambiguationSuffix;return baseName}var fkCols1=this._addForeignKeyColumns(table,table1,computeBaseName(table1.name,"_1"),columnNames1,endIdentities1);var fkCols2=this._addForeignKeyColumns(table,table2,computeBaseName(table2.name,"_2"),columnNames2,endIdentities2);return{table:table,fkCols1:fkCols1,fkCols2:fkCols2}};
websql.schema.Schema.prototype._defineSchemaForCollapsedRelation=function(relationSource,collapsedEnd){var end1=relationSource.end1;var end2=relationSource.end2;var otherEnd=collapsedEnd===end1?end2:end1;if(otherEnd.many)throw new Error("The other end of a collapsed relation cannot have 'many' cardinality");var collapsedTable=this._retrieveRelationEndTable(collapsedEnd);var otherTable=this._retrieveRelationEndTable(otherEnd);var relation=websql.schema.Relation.fromRelationProviderSchema(relationSource);
var collapsedEndIdentities=websql.schema.combineIdentities(relation.identities,otherEnd===end1?"/1":"/2");var columnNames=this._retrieveRelationEndColumnNames(collapsedEnd,otherTable,"columnName");var fkCols=this._addForeignKeyColumns(collapsedTable,otherTable,collapsedEnd.name,columnNames,collapsedEndIdentities);var collapsedSide=collapsedEnd==end1?websql.RelationSide.ONE:websql.RelationSide.TWO;if(collapsedSide===websql.RelationSide.ONE)relation.initTables(collapsedTable,otherTable);else relation.initTables(otherTable,
collapsedTable);relation.initAccessor(new websql.RelationAccessor.Collapsed(collapsedSide,{table:collapsedTable,endName:collapsedEnd.innerName,columns:fkCols,many:collapsedEnd.many},{table:otherTable,endName:otherEnd.innerName}));this.addRelation(relation);collapsedTable.addAttachedRelation(relation,collapsedSide,collapsedEnd.name);otherTable.addAttachedRelation(relation,websql.RelationSide.oppositeOf(collapsedSide),otherEnd.name)};
websql.schema.Schema.prototype._addForeignKeyColumns=function(table,referencedTable,baseColumnName,specificColumnNames,baseColumnIdentities){var referencedColumns=referencedTable.keyColumns.slice();var referenceIdentities=referencedColumns.length>1?[]:baseColumnIdentities;var columns=referencedColumns.map(function(refColumn){var ownIdentities=websql.schema.combineIdentities(baseColumnIdentities,"/:fkcol:/",referencedTable.identities,"/",refColumn.identities);var identities=referenceIdentities.concat(ownIdentities);
var columnName=specificColumnNames[refColumn.name]||baseColumnName+"__"+refColumn.name;var column=websql.schema.Column.fromColumn(refColumn,columnName,identities);table.addColumn(column);return column},this);if(this._useForeignKeys)table.addForeignKey(new websql.schema.ForeignKey(columns,referencedTable,referencedColumns));return columns};
websql.schema.Schema.prototype._retrieveRelationEndTable=function(relationEnd){var table=this.tablesByStoreName[relationEnd.storeName];if(!table)throw new Error("Invalid store '"+relationEnd.storeName+"' referenced by relation end '"+relationEnd.name);return table};
websql.schema.Schema.prototype._retrieveRelationEndColumnNames=function(relationEnd,refTable,propertyPrefix){var result={};Object.keys(relationEnd.properties).map(function(key){if(key.indexOf(propertyPrefix)===0){var fieldName=key.substring(propertyPrefix.length+".".length);var refColumn=refTable.columnsByFieldName[fieldName];if(!refColumn)throw new Error("Invalid field '"+fieldName+"' referenced by relation end '"+relationEnd.name);result[refColumn.name]=relationEnd.properties[key]}});return result};
websql.schema.Schema.prototype.addRelation=function(relation){this.ensureNotSealed();this.relations.push(relation);if(this.relationsByName[relation.name])throw new Error("Relation name '"+relation.name+"' already in use");this.relationsByName[relation.name]=relation};
websql.schema.Schema.prototype._defineSchemaForIndex=function(table,indexSource){var columns=indexSource.fieldNames.map(function(fieldName){var column=table.columnsByFieldName[fieldName];if(!column)throw new Error("Invalid field '"+fieldName+"' referenced by index");return column},this);var indexName=indexSource.properties["indexName"]||"idx_"+table.name+"_"+columns.map(function(column){return column.name},this).join("_");var index=new websql.schema.Index(indexName,indexSource.unique,columns);this.addIndex(index)};
websql.schema.Schema.prototype.addIndex=function(index){this.ensureNotSealed();this.indexes.push(index);if(this.indexesByName[index.name])throw new Error("Index name '"+index.name+"' already in use");this.indexesByName[index.name]=index};websql.schema.Schema.prototype.seal=function(){this.tables.forEach(function(table){table.seal()});this.relations.forEach(function(relation){relation.seal()});this.indexes.forEach(function(index){index.seal()});websql.schema.Schema._super.seal.call(this)};
websql.schema.Schema.fromProviderSchema=function(source){var options={foreignKeys:source.properties["foreignKeys"]===true,triggers:source.properties["triggers"]===true,maxStatementInputs:source.properties["maxStatementInputs"]};var schema=new websql.schema.Schema(options);source.stores.forEach(schema._defineSchemaForStore,schema);source.relations.forEach(schema._defineSchemaForRelation,schema);return schema};websql.schema._NAME_IDENTITY_PREFIX=":name:";websql.schema.normalizeIdentities=function(identities,elementName){if(identities.length>0)return identities.slice();return[websql.schema._NAME_IDENTITY_PREFIX+elementName]};
websql.schema.combineIdentities=function(var_args){var steps=Array.prototype.slice.apply(arguments);return steps.reduce(function(combined,step,index){var combinedArray=index>1||Array.isArray(combined)?combined:[combined];var stepArray=Array.isArray(step)?step:[step];var nextCombined=[];for(var i=0;i<combinedArray.length;i++)for(var j=0;j<stepArray.length;j++)nextCombined.push(String(combinedArray[i])+stepArray[j]);return nextCombined})};
websql.schema.mergeIdentities=function(var_args){var steps=Array.prototype.slice.apply(arguments);return steps.reduce(function(merged,step,index){var mergedArray=index>1||Array.isArray(merged)?merged:[merged];var stepArray=Array.isArray(step)?step:[step];var nextMerged=[];if(mergedArray.length!==stepArray.length)throw new Error("Attempting to merge different numbers of identities");for(var i=0;i<mergedArray.length;i++)nextMerged.push(String(mergedArray[i])+stepArray[i]);return nextMerged})};websql.TableDeleteCommandBuilder=function(db,storeName){websql.WriteCommandBuilder.call(this,db,storeName,{flatVariants:true})};extendConstructor(websql.TableDeleteCommandBuilder,websql.WriteCommandBuilder);exportSymbol("websql.TableDeleteCommandBuilder",websql.TableDeleteCommandBuilder);websql.TableDeleteCommandBuilder.prototype.addFilter=function(expr){this.includeFilter(expr)};exportProperty(websql.TableDeleteCommandBuilder.prototype,"addFilter",websql.TableDeleteCommandBuilder.prototype.addFilter);
websql.TableDeleteCommandBuilder.prototype.addOutputField=function(fieldPath,propertyName){this.includeBeforeTrackedField(fieldPath,propertyName)};exportProperty(websql.TableDeleteCommandBuilder.prototype,"addOutputField",websql.TableDeleteCommandBuilder.prototype.addOutputField);
websql.TableDeleteCommandBuilder.prototype.buildNormal=function(){var b=new websql.query.QueryTemplateBuilder;b.sql("DELETE FROM").sql(this.buildTableExpression());if(this.isWhereExpressionAvailable()){b.sql("WHERE");if(this.isFlatQueriesOnly())b.expansion(this.buildWhereExpression());else{b.sql(websql.query.ROWID_COLUMN_NAME).sql("IN").groupStart("(");b.expansion(this.buildWhereSubQuery());b.groupEnd(")")}}var queryTemplate=b.build();return new websql.NormalWriteCommand(queryTemplate)};
exportProperty(websql.TableDeleteCommandBuilder.prototype,"buildNormal",websql.TableDeleteCommandBuilder.prototype.buildNormal);
websql.TableDeleteCommandBuilder.prototype.buildTracking=function(){var beforePass=this.buildBeforeTrackingPassthroughs();var beforeCmd=this.buildBeforeTrackingCommand(websql.TableSelectCommandBuilder,websql.TrackingWriteCommand.ROWID_PROPERTY_NAME);var b=new websql.query.QueryTemplateBuilder;b.sql("DELETE FROM").sql(this.buildTableExpression());b.sql("WHERE");b.expansion(this.buildFlatWhereOnRowid(websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER));var queryTemplate=b.build();return new websql.TrackingWriteCommand(this.db,
queryTemplate,beforePass,beforeCmd,null,null)};exportProperty(websql.TableDeleteCommandBuilder.prototype,"buildTracking",websql.TableDeleteCommandBuilder.prototype.buildTracking);websql.TableInsertCommandBuilder=function(db,storeName){websql.WriteCommandBuilder.call(this,db,storeName,{forbidJoins:true})};extendConstructor(websql.TableInsertCommandBuilder,websql.WriteCommandBuilder);exportSymbol("websql.TableInsertCommandBuilder",websql.TableInsertCommandBuilder);websql.TableInsertCommandBuilder.prototype.addInputField=function(fieldPath,valueParameter){this.includeInputField(fieldPath,valueParameter);this.includeAfterExpectedField(fieldPath,valueParameter)};
exportProperty(websql.TableInsertCommandBuilder.prototype,"addInputField",websql.TableInsertCommandBuilder.prototype.addInputField);websql.TableInsertCommandBuilder.prototype.addOutputField=function(fieldPath,propertyName){this.includeAfterTrackedField(fieldPath,propertyName)};exportProperty(websql.TableInsertCommandBuilder.prototype,"addOutputField",websql.TableInsertCommandBuilder.prototype.addOutputField);
websql.TableInsertCommandBuilder.prototype.buildNormal=function(){var b=new websql.query.QueryTemplateBuilder;b.sql("INSERT INTO").sql(this.buildTableExpression());b.sql(this.buildInsertList());b.sql("VALUES").fragment(this.buildValuesList());var queryTemplate=b.build();return new websql.NormalWriteCommand(queryTemplate)};exportProperty(websql.TableInsertCommandBuilder.prototype,"buildNormal",websql.TableInsertCommandBuilder.prototype.buildNormal);
websql.TableInsertCommandBuilder.prototype.buildTracking=function(){var afterPass=this.buildAfterTrackingPassthroughs();var afterCmd=this.buildAfterTrackingCommand(websql.TableSelectCommandBuilder,websql.TrackingWriteCommand.ROWID_PROPERTY_NAME,websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER);var b=new websql.query.QueryTemplateBuilder;b.sql("INSERT INTO").sql(this.buildTableExpression());b.sql(this.buildInsertList());b.sql("VALUES").fragment(this.buildValuesList());var queryTemplate=b.build();
return new websql.TrackingWriteCommand(this.db,queryTemplate,null,null,afterPass,afterCmd)};exportProperty(websql.TableInsertCommandBuilder.prototype,"buildTracking",websql.TableInsertCommandBuilder.prototype.buildTracking);websql.TableSelectCommandBuilder=function(db,storeName){websql.SelectCommandBuilder.call(this,db,storeName);this._distinct=false};extendConstructor(websql.TableSelectCommandBuilder,websql.SelectCommandBuilder);exportSymbol("websql.TableSelectCommandBuilder",websql.TableSelectCommandBuilder);websql.TableSelectCommandBuilder.prototype.useDistinct=function(){if(this._distinct)throw new Error("Distinct already set");this._distinct=true};
exportProperty(websql.TableSelectCommandBuilder.prototype,"useDistinct",websql.TableSelectCommandBuilder.prototype.useDistinct);websql.TableSelectCommandBuilder.prototype.addOutputField=function(fieldPath,propertyName){this.includeOutputField(fieldPath,propertyName)};exportProperty(websql.TableSelectCommandBuilder.prototype,"addOutputField",websql.TableSelectCommandBuilder.prototype.addOutputField);websql.TableSelectCommandBuilder.prototype.addFilter=function(expr){this.includeFilter(expr)};
exportProperty(websql.TableSelectCommandBuilder.prototype,"addFilter",websql.TableSelectCommandBuilder.prototype.addFilter);websql.TableSelectCommandBuilder.prototype.addOrderTerm=function(term){this.includeOrderTerm(term)};exportProperty(websql.TableSelectCommandBuilder.prototype,"addOrderTerm",websql.TableSelectCommandBuilder.prototype.addOrderTerm);websql.TableSelectCommandBuilder.prototype.addLimit=function(limit){this.includeLimit(limit)};
exportProperty(websql.TableSelectCommandBuilder.prototype,"addLimit",websql.TableSelectCommandBuilder.prototype.addLimit);
websql.TableSelectCommandBuilder.prototype.build=function(){var helper=new websql.SelectionHelper(this);var extraResultColumns=helper.getExtraResultColumns();var extraOrderTerms=helper.getExtraOrderTerms();var b=new websql.query.QueryTemplateBuilder;b.sql(this._distinct?"SELECT DISTINCT":"SELECT");b.sql(this.buildResultList(extraResultColumns));b.sql("FROM").sql(this.buildFromExpression());if(this.isWhereExpressionAvailable())b.sql("WHERE").expansion(this.buildWhereExpression());if(this.isOrderExpressionAvailable()||
extraOrderTerms.length>0)b.sql("ORDER BY").sql(this.buildOrderExpression(extraOrderTerms));if(this.isLimitExpressionAvailable())b.sql("LIMIT").sql(this.buildLimitExpression());var queryTemplate=b.build();var assemblerFactory=helper.createAssemblerFactory(this.getResultColumns());return new websql.NormalSelectCommand(queryTemplate,assemblerFactory)};exportProperty(websql.TableSelectCommandBuilder.prototype,"build",websql.TableSelectCommandBuilder.prototype.build);websql.TableUpdateCommandBuilder=function(db,storeName){websql.WriteCommandBuilder.call(this,db,storeName,{flatVariants:true})};extendConstructor(websql.TableUpdateCommandBuilder,websql.WriteCommandBuilder);exportSymbol("websql.TableUpdateCommandBuilder",websql.TableUpdateCommandBuilder);websql.TableUpdateCommandBuilder.prototype.addInputField=function(fieldPath,valueParameter){this.includeInputField(fieldPath,valueParameter);this.includeAfterExpectedField(fieldPath,valueParameter)};
exportProperty(websql.TableUpdateCommandBuilder.prototype,"addInputField",websql.TableUpdateCommandBuilder.prototype.addInputField);websql.TableUpdateCommandBuilder.prototype.addFilter=function(expr){this.includeFilter(expr)};exportProperty(websql.TableUpdateCommandBuilder.prototype,"addFilter",websql.TableUpdateCommandBuilder.prototype.addFilter);
websql.TableUpdateCommandBuilder.prototype.addOutputField=function(fieldPath,before,propertyName){if(before)this.includeBeforeTrackedField(fieldPath,propertyName);else this.includeAfterTrackedField(fieldPath,propertyName)};exportProperty(websql.TableUpdateCommandBuilder.prototype,"addOutputField",websql.TableUpdateCommandBuilder.prototype.addOutputField);
websql.TableUpdateCommandBuilder.prototype.buildNormal=function(){var b=new websql.query.QueryTemplateBuilder;b.sql("UPDATE").sql(this.buildTableExpression());b.sql("SET").fragment(this.buildSetList());if(this.isWhereExpressionAvailable()){b.sql("WHERE");if(this.isFlatQueriesOnly())b.expansion(this.buildWhereExpression());else{b.sql(websql.query.ROWID_COLUMN_NAME).sql("IN").groupStart("(");b.expansion(this.buildWhereSubQuery());b.groupEnd(")")}}var queryTemplate=b.build();return new websql.NormalWriteCommand(queryTemplate)};
exportProperty(websql.TableUpdateCommandBuilder.prototype,"buildNormal",websql.TableUpdateCommandBuilder.prototype.buildNormal);
websql.TableUpdateCommandBuilder.prototype.buildTracking=function(){var beforePass=this.buildBeforeTrackingPassthroughs();var beforeCmd=this.buildBeforeTrackingCommand(websql.TableSelectCommandBuilder,websql.TrackingWriteCommand.ROWID_PROPERTY_NAME);var afterPass=this.buildAfterTrackingPassthroughs();var afterCmd=this.buildAfterTrackingCommand(websql.TableSelectCommandBuilder,websql.TrackingWriteCommand.ROWID_PROPERTY_NAME,websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER);var b=new websql.query.QueryTemplateBuilder;
b.sql("UPDATE").sql(this.buildTableExpression());b.sql("SET").fragment(this.buildSetList());b.sql("WHERE");b.expansion(this.buildFlatWhereOnRowid(websql.TrackingWriteCommand.ROWID_VALUE_PARAMETER));var queryTemplate=b.build();return new websql.TrackingWriteCommand(this.db,queryTemplate,beforePass,beforeCmd,afterPass,afterCmd)};exportProperty(websql.TableUpdateCommandBuilder.prototype,"buildTracking",websql.TableUpdateCommandBuilder.prototype.buildTracking);websql.Transaction=function(db,dbConn,writeEnabled,sharedDbTx){this._db=db;this._dbConn=dbConn;this._writeEnabled=writeEnabled;this._dbTx=sharedDbTx;this._resolved=false};exportSymbol("websql.Transaction",websql.Transaction);websql.Transaction.prototype.getDatabase=function(){return this._db};exportProperty(websql.Transaction.prototype,"getDatabase",websql.Transaction.prototype.getDatabase);
websql.Transaction.prototype.executeCommand=function(command,parameters,metadataEmbedder){this._checkNotResolved();if("isUpdate"in command){var oldCommand=(command);if(oldCommand.isUpdate)return this._executeUpdateCommandOLD(this._dbTx,oldCommand,parameters);else return this._executeInsertCommandOLD(this._dbTx,oldCommand,parameters)}var tx=this;return new Promise(function(resolve,reject){command.execute(tx,parameters,resolve,reject)})};
exportProperty(websql.Transaction.prototype,"executeCommand",websql.Transaction.prototype.executeCommand);
websql.Transaction.prototype._executeInsertCommandOLD=function(dbTx,command,parameters){if(!dbTx)throw new Error("Must be run in a transaction");var paramsArray=command.parameterNames.map(function(paramName,i){var conv=command.parameterConvs[i];return conv(parameters[paramName])});return new Promise(function(resolve,reject){dbTx.executeSql(command.sql,paramsArray,function(tx,result){command.resultConv(tx,parameters,result,resolve,reject)},function(tx,e){reject(new Error("[SQL"+e.code+"]: "+e.message))})})};
websql.Transaction.prototype._executeUpdateCommandOLD=function(dbTx,command,parameters){if(!dbTx)throw new Error("Must be run in a transaction");var paramsArray=command.parameterNames.map(function(paramName,i){var conv=command.parameterConvs[i];return conv(parameters[paramName])});return new Promise(function(resolve,reject){dbTx.executeSql(command.sql,paramsArray,function(tx,result){command.resultConv(tx,parameters,result,resolve,reject)},function(tx,e){reject(new Error("[SQL"+e.code+"]: "+e.message))})})};
websql.Transaction.prototype.runInTransaction=function(txCallback){if(websql.activeTx){txCallback(websql.activeTx);return}if(this._dbTx){txCallback(this._dbTx);return}websql.runTransaction(this._db,this._dbConn,this._writeEnabled,txCallback)};websql.Transaction.prototype.resolve=function(){this._checkNotResolved();if(this._dbTx&&"release"in this._dbTx)this._dbTx["release"]();this._resolved=true};exportProperty(websql.Transaction.prototype,"resolve",websql.Transaction.prototype.resolve);
websql.Transaction.prototype._checkNotResolved=function(){if(this._resolved)throw new Error("Transaction is no longer available");};websql.util={};
websql.util.computeObjectsDiff=function(oldObjects,newObjects,keyFunction){if(!keyFunction)keyFunction=function(object){return String(object)};var classes={},classCount=0;function classifyObjects(objects,otherResults){var result={};function generateClassId(){return String(classCount++)}function retrieveClassIds(keys){if(keys.length===1){if(classes[keys[0]]===undefined)return[classes[keys[0]]=generateClassId()];return[classes[keys[0]]]}var classIdsSet={};keys.forEach(function(key){var classId=classes[key];
if(classId!==undefined)classIdsSet[classId]=true});var classIdsList=Object.keys(classIdsSet);var singleClassId;if(classIdsList.length===1)singleClassId=classIdsList[0];else singleClassId=generateClassId();keys.forEach(function(key){classes[key]=singleClassId});if(classIdsList.length>1)return[singleClassId].concat(classIdsList);return[singleClassId]}function retrieveClassList(keys){var classIds=retrieveClassIds(keys);var list;if(classIds.length===1){list=result[classIds[0]];if(!list)result[classIds[0]]=
list=[];return list}else{var mergedClassId=classIds[0];var otherClassIds=classIds.slice(1);list=mergeClasses(result,mergedClassId,otherClassIds);otherResults.forEach(function(otherResult){mergeClasses(otherResult,mergedClassId,otherClassIds)})}function mergeClasses(listsMap,newClassId,classIds){var mergedList=[];classIds.forEach(function(classId){var partialList=listsMap[classId];if(partialList){Array.prototype.push.apply(mergedList,partialList);delete listsMap[classId]}});listsMap[newClassId]=mergedList;
return mergedList}return list}objects.forEach(function(object){if(object===null||object===undefined)throw new Error("Found null/undefined objects");var keys=keyFunction(object);if(!Array.isArray(keys))keys=[keys];if(keys.length<=0)throw new Error("Found objects with no keys");retrieveClassList((keys)).push(object)});return result}var oldObjectsClassified=classifyObjects(oldObjects,[]);var newObjectsClassified=classifyObjects(newObjects,[oldObjectsClassified]);var diff={added:[],replaced:[],removed:[]};
var oldIdsSet={};Object.keys(oldObjectsClassified).forEach(function(id){oldIdsSet[id]=true});Object.keys(newObjectsClassified).forEach(function(id){if(oldIdsSet[id]===true){delete oldIdsSet[id];var older=oldObjectsClassified[id];var newer=newObjectsClassified[id];if(older.length!=newer.length||older.length>1||older.length===1&&older[0]!==newer[0])diff.replaced.push({older:older,newer:newer})}else Array.prototype.push.apply(diff.added,newObjectsClassified[id])});Object.keys(oldIdsSet).forEach(function(id){Array.prototype.push.apply(diff.removed,
oldObjectsClassified[id])});return diff};websql.util.assignObject=function(target,var_args){if(target===undefined||target===null)throw new TypeError("Cannot convert first argument to object");target=Object(target);for(var i=1;i<arguments.length;i++){var source=arguments[i];if(source===undefined||source===null)continue;source=Object(source);for(var key in source){if(!source.hasOwnProperty(key))continue;target[key]=source[key]}}return target};})();})(this);